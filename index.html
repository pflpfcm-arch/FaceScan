<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFL Attendance – ลงเวลาทำงาน</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Face API & Crypto -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .numpad-btn {
            @apply w-16 h-16 rounded-full flex items-center justify-center text-xl font-semibold bg-white shadow-sm border border-gray-100 hover:bg-blue-50 transition-all active:scale-95;
        }
        #video-container { position: relative; width: 100%; max-width: 400px; border-radius: 1rem; overflow: hidden; background: #000; }
        #login-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay { transition: opacity 0.5s ease-out; }
        .tab-active { @apply border-b-2 border-blue-600 text-blue-600 font-bold; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center space-y-4">
        <div class="loader w-12 h-12 border-4"></div>
        <p class="text-gray-600 animate-pulse font-medium">กำลังเตรียมระบบสแกนใบหน้า...</p>
    </div>

    <!-- Header -->
    <header id="main-header" class="hidden bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="truck" class="text-white w-5 h-5"></i></div>
                <h1 class="text-lg font-bold text-gray-800">PFL Attendance</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="btn-admin-config" onclick="enterAdminSettings()" class="p-2 text-gray-400 hover:text-blue-600 transition-colors" title="ตั้งค่า Admin">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <button onclick="logout()" class="text-sm text-red-500 font-medium flex items-center hover:bg-red-50 px-3 py-1 rounded-lg transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4 mr-1"></i> ออกจากระบบ
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-6xl p-4 space-y-6">
        
        <!-- SECTION: Login -->
        <div id="view-login" class="max-w-lg mx-auto space-y-6 text-center py-10">
            <div class="flex justify-between items-center px-4">
                <h2 class="text-2xl font-bold text-gray-800">เข้าสู่ระบบ</h2>
                <button onclick="enterAdminSettings()" class="text-[10px] text-gray-300 hover:text-gray-500 flex items-center gap-1">
                    <i data-lucide="lock" class="w-3 h-3"></i> ADMIN
                </button>
            </div>
            
            <div class="flex justify-center space-x-8 mb-6 border-b border-gray-100 text-gray-400 text-sm">
                <button id="tab-face" onclick="switchLoginMode('face')" class="pb-2 tab-active flex items-center gap-2 transition-all"><i data-lucide="scan-face" class="w-4 h-4"></i> สแกนใบหน้า</button>
                <button id="tab-pin" onclick="switchLoginMode('pin')" class="pb-2 flex items-center gap-2 transition-all"><i data-lucide="keypad" class="w-4 h-4"></i> รหัส PIN</button>
            </div>

            <!-- Face Login Section -->
            <div id="login-face-section" class="space-y-4">
                <div id="video-container" class="mx-auto aspect-square ring-4 ring-blue-50 ring-offset-2">
                    <video id="login-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <canvas id="login-overlay"></canvas>
                </div>
                <div class="space-y-1">
                    <p class="text-sm font-medium text-blue-600" id="face-login-status">กำลังสแกนหาใบหน้า...</p>
                </div>
            </div>

            <div id="login-pin-section" class="hidden space-y-6">
                <p class="text-gray-500 text-sm">ระบุรหัส PIN 6 หลักของคุณ</p>
                <div id="pin-display" class="flex justify-center space-x-3 my-6"></div>
                <div class="grid grid-cols-3 gap-4 max-w-xs mx-auto">
                    <button onclick="pressPin(1)" class="numpad-btn">1</button>
                    <button onclick="pressPin(2)" class="numpad-btn">2</button>
                    <button onclick="pressPin(3)" class="numpad-btn">3</button>
                    <button onclick="pressPin(4)" class="numpad-btn">4</button>
                    <button onclick="pressPin(5)" class="numpad-btn">5</button>
                    <button onclick="pressPin(6)" class="numpad-btn">6</button>
                    <button onclick="pressPin(7)" class="numpad-btn">7</button>
                    <button onclick="pressPin(8)" class="numpad-btn">8</button>
                    <button onclick="pressPin(9)" class="numpad-btn">9</button>
                    <button onclick="retryFetchData()" class="numpad-btn text-blue-500"><i data-lucide="refresh-cw" class="w-6 h-6"></i></button>
                    <button onclick="pressPin(0)" class="numpad-btn">0</button>
                    <button onclick="clearPin()" class="numpad-btn text-red-500"><i data-lucide="delete"></i></button>
                </div>
            </div>

            <p class="mt-8 text-sm text-gray-400">ยังไม่มีข้อมูลในระบบ? <button onclick="switchView('view-register')" class="text-blue-600 font-semibold underline">ลงทะเบียนใหม่</button></p>
        </div>

        <!-- SECTION: Register -->
        <div id="view-register" class="max-w-lg mx-auto hidden space-y-6">
            <div class="flex items-center space-x-2">
                <button onclick="switchView('view-login')" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-xl font-bold">ลงทะเบียนพนักงาน</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                <div id="reg-form-content">
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกชื่อของคุณ</label>
                    <select id="reg-user-list" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-400 transition-all"></select>
                </div>
                <div id="face-scan-section" class="hidden space-y-4 text-center">
                    <p class="text-sm font-semibold text-blue-600" id="scan-status">กรุณามองหน้าตรงเพื่อบันทึกใบหน้า</p>
                    <div id="reg-video-container" class="mx-auto aspect-square rounded-2xl overflow-hidden bg-black ring-4 ring-blue-50">
                        <video id="reg-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                        <canvas id="reg-overlay"></canvas>
                    </div>
                </div>
                <div id="pin-setup-section" class="hidden space-y-4">
                    <p class="text-center font-medium text-sm">ตั้งรหัส PIN 6 หลัก</p>
                    <input type="password" id="reg-pin" maxlength="6" inputmode="numeric" class="w-full text-center text-3xl tracking-[0.5em] p-4 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-blue-400 outline-none" placeholder="******">
                    <input type="password" id="reg-pin-confirm" maxlength="6" inputmode="numeric" class="w-full text-center text-3xl tracking-[0.5em] p-4 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-blue-400 outline-none mt-2" placeholder="******">
                </div>
                <button id="btn-next-step" onclick="handleRegisterNext()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">เริ่มสแกนใบหน้า</button>
            </div>
        </div>

        <!-- SECTION: Main Integrated Dashboard -->
        <div id="view-main" class="hidden space-y-8 pb-10">
            
            <!-- User Control Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Card -->
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl card-shadow text-center border border-gray-50 space-y-4 relative overflow-hidden">
                    <div id="admin-badge" class="hidden absolute top-3 right-3 bg-red-100 text-red-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-red-200 uppercase">ADMIN MODE</div>
                    <h3 class="text-gray-400 text-sm">ยินดีต้อนรับ</h3>
                    <div id="display-user-name" class="font-bold text-gray-800 text-2xl">-</div>
                    <div class="py-4 border-y border-gray-50">
                        <div class="text-4xl font-bold text-blue-600" id="current-time">00:00:00</div>
                        <div class="text-gray-500 text-sm mt-1" id="current-date">-</div>
                    </div>
                    <div id="gps-banner" class="flex items-center justify-center p-3 bg-yellow-50 text-yellow-700 rounded-xl text-[10px] border border-yellow-100">
                        <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i>
                        <span id="gps-text">กำลังเช็คพิกัด GPS...</span>
                    </div>
                </div>

                <!-- Attendance Form -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl card-shadow border border-gray-50 space-y-4">
                    <div id="admin-user-selector" class="hidden pb-4 border-b border-gray-100">
                        <label class="text-xs font-bold text-red-600 flex items-center gap-1 mb-2"><i data-lucide="users" class="w-3 h-3"></i> ลงบันทึกแทนพนักงาน:</label>
                        <select id="admin-target-user" class="w-full p-2 bg-red-50 border border-red-100 rounded-lg text-sm outline-none">
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-gray-500">จุดเข้าบริษัท</label>
                            <select id="point-company" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm focus:ring-1 focus:ring-blue-400 outline-none">
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-gray-500">จุดเข้างาน</label>
                            <select id="point-work" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm focus:ring-1 focus:ring-blue-400 outline-none">
                            </select>
                        </div>
                    </div>
                    <textarea id="attendance-note" rows="1" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm focus:ring-1 focus:ring-blue-400 outline-none" placeholder="ระบุหมายเหตุ..."></textarea>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="submitAttendance('มาทำงาน')" class="bg-green-600 text-white p-3 rounded-xl font-bold shadow-sm hover:bg-green-700 transition-all flex flex-col items-center justify-center gap-1">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            <span class="text-xs">มาทำงาน</span>
                        </button>
                        <button onclick="submitAttendance('ลาหยุด')" class="bg-red-50 text-red-600 p-3 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition-all flex flex-col items-center justify-center gap-1">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                            <span class="text-xs">ลาหยุด</span>
                        </button>
                        <button onclick="submitAttendance('ลาครึ่งวัน')" class="bg-orange-50 text-orange-600 p-3 rounded-xl font-bold border border-orange-100 hover:bg-orange-100 transition-all flex flex-col items-center justify-center gap-1">
                            <i data-lucide="clock-3" class="w-5 h-5"></i>
                            <span class="text-xs">ลาครึ่งวัน</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Dashboard -->
            <div class="space-y-6 pt-4 border-t border-gray-200">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-6 h-6 text-blue-600"></i> รายงานประจำวัน</h3>
                    <div class="flex items-center gap-2 bg-white p-1.5 rounded-xl card-shadow border border-gray-100 text-sm">
                        <input type="date" id="filter-date" onchange="renderGlobalReport()" class="p-2 bg-transparent outline-none">
                        <select id="filter-status" onchange="renderGlobalReport()" class="p-2 bg-transparent outline-none">
                            <option value="ทั้งหมด">ทั้งหมด</option>
                            <option value="มาทำงาน">มาทำงาน</option>
                            <option value="ลาหยุด">ลาหยุด</option>
                            <option value="ลาครึ่งวัน">ลาครึ่งวัน</option>
                            <option value="ยังไม่ลงบันทึก">ยังไม่ลงบันทึก</option>
                        </select>
                        <button onclick="exportCSV()" class="p-2 text-gray-400 hover:text-blue-600 transition-colors" title="Download CSV"><i data-lucide="download" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-2xl border-l-4 border-green-500 card-shadow">
                        <p class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">มาทำงาน</p>
                        <p id="sum-present" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border-l-4 border-red-500 card-shadow">
                        <p class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">ลาหยุด</p>
                        <p id="sum-leave" class="text-2xl font-bold text-red-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border-l-4 border-orange-400 card-shadow">
                        <p class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">ลาครึ่งวัน</p>
                        <p id="sum-half" class="text-2xl font-bold text-orange-500">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border-l-4 border-gray-300 card-shadow">
                        <p class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">ยังไม่ลงบันทึก</p>
                        <p id="sum-missing" class="text-2xl font-bold text-gray-500">0</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl card-shadow border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500 font-semibold border-b border-gray-100">
                                <tr>
                                    <th class="px-6 py-4">ชื่อ</th>
                                    <th class="px-4 py-4 text-center">สถานะ</th>
                                    <th class="px-4 py-4">เข้างาน</th>
                                    <th class="px-4 py-4">เข้าบริษัท</th>
                                    <th class="px-6 py-4">หมายเหตุ</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="divide-y divide-gray-50 font-medium text-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: Admin CRUD Panel -->
        <div id="view-admin-crud" class="hidden space-y-8 pb-10">
            <div class="flex items-center justify-between">
                <button onclick="switchView('view-main')" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-2xl font-bold text-gray-800">แผงควบคุมระบบ (Admin)</h2>
                <div></div>
            </div>

            <!-- Employee Management CRUD -->
            <div class="bg-white p-6 rounded-2xl card-shadow border border-gray-50 space-y-6">
                <div class="flex items-center justify-between">
                    <h4 class="font-bold text-lg text-gray-700 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-blue-500"></i> จัดการรายชื่อพนักงาน</h4>
                    <button onclick="showUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-blue-700 transition-all flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> เพิ่มพนักงาน
                    </button>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 font-semibold">
                            <tr>
                                <th class="px-4 py-3">รหัสพนักงาน</th>
                                <th class="px-4 py-3">ชื่อเล่น</th>
                                <th class="px-4 py-3 text-center">สิทธิ์</th>
                                <th class="px-4 py-3 text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="list-users-crud" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- Points CRUD -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl card-shadow border border-gray-50 space-y-4">
                    <h4 class="font-bold text-gray-700 flex items-center justify-between">
                        <span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5 text-green-500"></i> จุดเข้าบริษัท</span>
                        <button onclick="showPointModal('EntryPoints')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded-lg">+ เพิ่ม</button>
                    </h4>
                    <div id="list-entry-points" class="space-y-2"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl card-shadow border border-gray-50 space-y-4">
                    <h4 class="font-bold text-gray-700 flex items-center justify-between">
                        <span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5 text-orange-500"></i> จุดเข้างาน</span>
                        <button onclick="showPointModal('WorkPoints')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded-lg">+ เพิ่ม</button>
                    </h4>
                    <div id="list-work-points" class="space-y-2"></div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t p-6 text-center text-gray-400 text-[10px] uppercase tracking-widest">
        <p>COPY RIGHT 2026 @ ฝ่ายกำกับรถพาเหรด</p>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyqyQfHWTnj7yZiOyLOVs8qjU2HdtAvK1gfKhPmrCgdFTPV8WiWUZ-Q3O82Wd6c3VHX_A/exec";
        const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models"; 

        let state = {
            user: null, pin: "", location: { lat: 0, lng: 0 },
            users: [], attendance: [],
            entryPoints: [], workPoints: [],
            view: "view-login", registerStep: 1,
            loginMode: "face", isAdmin: false,
            currentStream: null, faceMatcher: null
        };

        window.onload = async () => {
            initLucide();
            updateTime();
            setInterval(updateTime, 1000);
            document.getElementById('filter-date').valueAsDate = new Date();
            
            try {
                await initFaceModels();
                await fetchData();
                startFaceLogin();
            } catch (err) { console.error(err); } 
            finally { document.getElementById('loading-overlay').style.display = 'none'; }

            initGPS();
            renderPinDots();
            checkSession();
        };

        function initLucide() { if (typeof lucide !== 'undefined') lucide.createIcons(); else setTimeout(initLucide, 500); }

        async function initFaceModels() {
            if (typeof faceapi !== 'undefined' && faceapi.nets) {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
            }
        }

        async function fetchData() {
            try {
                const [uRes, aRes, epRes, wpRes] = await Promise.all([
                    fetch(`${API_URL}?action=getUsers`),
                    fetch(`${API_URL}?action=getAttendance`),
                    fetch(`${API_URL}?action=getEntryPoints`),
                    fetch(`${API_URL}?action=getWorkPoints`)
                ]);
                state.users = await uRes.json();
                state.attendance = await aRes.json();
                state.entryPoints = await epRes.json();
                state.workPoints = await wpRes.json();
                
                const labeledDescriptors = [];
                state.users.forEach(u => {
                    if (u.faceDescriptor) {
                        try {
                            const desc = new Float32Array(Object.values(JSON.parse(u.faceDescriptor)));
                            labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(u.id.toString(), [desc]));
                        } catch (e) {}
                    }
                });
                if (labeledDescriptors.length > 0) state.faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                
                populateSelectors();
                renderGlobalReport();
                renderCRUDLists();
            } catch (e) { console.error("Fetch Error", e); }
        }

        function populateSelectors() {
            const regList = document.getElementById('reg-user-list');
            const targetUser = document.getElementById('admin-target-user');
            const epSelect = document.getElementById('point-company');
            const wpSelect = document.getElementById('point-work');

            if(regList) {
                regList.innerHTML = '<option value="">-- เลือกรายชื่อ --</option>';
                state.users.forEach(u => regList.innerHTML += `<option value="${u.id}">${u.nickname} (${u.id})</option>`);
            }
            if(targetUser) {
                targetUser.innerHTML = '';
                state.users.forEach(u => targetUser.innerHTML += `<option value="${u.id}">${u.nickname} (${u.id})</option>`);
            }
            if(epSelect) {
                epSelect.innerHTML = '';
                state.entryPoints.forEach(p => epSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`);
            }
            if(wpSelect) {
                wpSelect.innerHTML = '';
                state.workPoints.forEach(p => wpSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`);
            }
        }

        function initGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((pos) => {
                    state.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    const gpsText = document.getElementById('gps-text');
                    if(gpsText) gpsText.innerText = `พิกัดปัจจุบัน: ${state.location.lat.toFixed(5)}, ${state.location.lng.toFixed(5)}`;
                    document.getElementById('gps-banner')?.classList.replace('bg-yellow-50', 'bg-green-50');
                }, () => {}, { enableHighAccuracy: true });
            }
        }

        function switchView(viewId) {
            stopAllVideo();
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(viewId)?.classList.remove('hidden');
            document.getElementById('main-header')?.classList.toggle('hidden', viewId === 'view-login' || viewId === 'view-register');
            if (viewId === 'view-login' && state.loginMode === 'face') startFaceLogin();
            if (viewId === 'view-main') renderGlobalReport();
            initLucide();
        }

        function switchLoginMode(mode) {
            state.loginMode = mode;
            stopAllVideo();
            document.getElementById('tab-face').className = mode === 'face' ? 'pb-2 tab-active flex items-center gap-2' : 'pb-2 flex items-center gap-2';
            document.getElementById('tab-pin').className = mode === 'pin' ? 'pb-2 tab-active flex items-center gap-2' : 'pb-2 flex items-center gap-2';
            document.getElementById('login-face-section').classList.toggle('hidden', mode !== 'face');
            document.getElementById('login-pin-section').classList.toggle('hidden', mode !== 'pin');
            if (mode === 'face') startFaceLogin();
            initLucide();
        }

        function stopAllVideo() {
            if (state.currentStream) { state.currentStream.getTracks().forEach(track => track.stop()); state.currentStream = null; }
        }

        async function startFaceLogin() {
            const video = document.getElementById('login-video');
            const statusEl = document.getElementById('face-login-status');
            const canvas = document.getElementById('login-overlay');
            if(!video || !canvas) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                state.currentStream = stream;
                video.srcObject = stream;
                video.onplay = () => {
                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    const interval = setInterval(async () => {
                        if (state.view !== 'view-login' || state.loginMode !== 'face') { clearInterval(interval); return; }
                        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        if (detection) {
                            const resizedDetection = faceapi.resizeResults(detection, displaySize);
                            new faceapi.draw.DrawBox(resizedDetection.detection.box, { label: 'Scanning...', boxColor: '#3b82f6' }).draw(canvas);
                            if (state.faceMatcher) {
                                const bestMatch = state.faceMatcher.findBestMatch(detection.descriptor);
                                if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) {
                                    const foundUser = state.users.find(u => u.id.toString() === bestMatch.label);
                                    if (foundUser) {
                                        new faceapi.draw.DrawBox(resizedDetection.detection.box, { label: foundUser.nickname, boxColor: '#10b981' }).draw(canvas);
                                        statusEl.innerText = "พบใบหน้า: " + foundUser.nickname;
                                        statusEl.className = "text-sm font-bold text-green-600";
                                        clearInterval(interval);
                                        setTimeout(() => loginSuccess(foundUser), 800);
                                    }
                                }
                            }
                        }
                    }, 300);
                };
            } catch (err) { statusEl.innerText = "กรุณาเปิดกล้อง"; }
        }

        function renderPinDots() {
            const container = document.getElementById('pin-display');
            if (!container) return;
            container.innerHTML = "";
            for(let i=0; i<6; i++) {
                const dot = document.createElement('div');
                dot.className = i < state.pin.length ? "w-4 h-4 rounded-full bg-blue-600 border-blue-600 scale-125 transition-all" : "w-4 h-4 rounded-full border-2 border-blue-200";
                container.appendChild(dot);
            }
        }

        function pressPin(num) { if(state.pin.length < 6) { state.pin += num; renderPinDots(); if(state.pin.length === 6) setTimeout(handlePinLogin, 300); } }
        function clearPin() { state.pin = ""; renderPinDots(); }

        async function handlePinLogin() {
            const hashedPin = CryptoJS.SHA256(state.pin).toString();
            const user = state.users.find(u => u.pin === hashedPin);
            if(user) loginSuccess(user);
            else { Swal.fire({ icon: 'error', title: 'รหัสผิด', text: 'PIN 6 หลักไม่ถูกต้อง' }); clearPin(); }
        }

        function loginSuccess(user) {
            state.user = user;
            localStorage.setItem('pfl_session', JSON.stringify({ user, expiry: Date.now() + 28800000 }));
            document.getElementById('display-user-name').innerText = user.nickname;
            switchView('view-main');
            clearPin();
        }

        function checkSession() {
            const s = localStorage.getItem('pfl_session');
            if (s) { try { const sess = JSON.parse(s); if(sess.expiry > Date.now()) { state.user = sess.user; document.getElementById('display-user-name').innerText = state.user.nickname; switchView('view-main'); } } catch(e) {} }
        }

        function logout() { stopAllVideo(); state.isAdmin = false; document.getElementById('admin-user-selector').classList.add('hidden'); document.getElementById('admin-badge').classList.add('hidden'); localStorage.removeItem('pfl_session'); state.user = null; switchView('view-login'); clearPin(); }

        async function submitAttendance(status) {
            const targetId = state.isAdmin ? document.getElementById('admin-target-user').value : state.user.id;
            const targetUser = state.users.find(u => u.id == targetId);
            
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

            const data = {
                userId: targetId, nickname: targetUser.nickname, status: status,
                timeWork: timeStr, pointWork: document.getElementById('point-work').value,
                timeCompany: timeStr, pointCompany: document.getElementById('point-company').value,
                note: document.getElementById('attendance-note').value,
                lat: state.location.lat, lng: state.location.lng, timestamp: now.toISOString()
            };

            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const res = await fetch(API_URL + "?action=saveAttendance", { method: 'POST', body: JSON.stringify(data) });
                const result = await res.json();
                if(result.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                    document.getElementById('attendance-note').value = "";
                    await fetchData();
                } else throw new Error();
            } catch (e) { Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถบันทึกข้อมูลได้' }); }
        }

        function renderGlobalReport() {
            const selDate = document.getElementById('filter-date').value;
            const selStatus = document.getElementById('filter-status').value;
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = "";
            let sums = { present: 0, leave: 0, half: 0, missing: 0 };

            state.users.forEach(u => {
                const att = state.attendance.find(a => {
                    const aDate = new Date(a.timestamp).toLocaleDateString('en-CA');
                    return a.userId == u.id && aDate === selDate;
                });

                const status = att ? att.status : "ยังไม่ลงบันทึก";
                if (status === "มาทำงาน") sums.present++;
                else if (status === "ลาหยุด") sums.leave++;
                else if (status === "ลาครึ่งวัน") sums.half++;
                else sums.missing++;

                if (selStatus !== "ทั้งหมด" && selStatus !== status) return;

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50">
                        <td class="px-6 py-4 font-bold text-gray-800">${u.nickname}</td>
                        <td class="px-4 py-4 text-center"><span class="px-3 py-1 rounded-full text-[10px] font-bold ${getStatusClass(status)}">${status}</span></td>
                        <td class="px-4 py-4 text-xs">
                           <div class="font-bold">${att ? att.pointWork : '-'}</div>
                           <div class="text-gray-400">${att ? att.timeWork : ''}</div>
                        </td>
                        <td class="px-4 py-4 text-xs">
                           <div class="font-bold">${att ? att.pointCompany : '-'}</div>
                           <div class="text-gray-400">${att ? att.timeCompany : ''}</div>
                        </td>
                        <td class="px-6 py-4 text-[10px] text-gray-400 italic">${att ? att.note : '-'}</td>
                    </tr>`;
            });
            document.getElementById('sum-present').innerText = sums.present;
            document.getElementById('sum-leave').innerText = sums.leave;
            document.getElementById('sum-half').innerText = sums.half;
            document.getElementById('sum-missing').innerText = sums.missing;
            initLucide();
        }

        function getStatusClass(s) {
            if (s === "มาทำงาน") return "bg-green-100 text-green-700";
            if (s === "ลาหยุด") return "bg-red-100 text-red-700";
            if (s === "ลาครึ่งวัน") return "bg-orange-100 text-orange-700";
            return "bg-gray-100 text-gray-400";
        }

        // --- ADMIN CRUD FEATURES ---
        function enterAdminSettings() {
            Swal.fire({
                title: 'โหมดผู้ดูแล',
                input: 'password',
                inputPlaceholder: 'ใส่รหัสผ่าน...',
                showCancelButton: true,
                confirmButtonText: 'เข้าสู่ระบบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.value === 'pflpfcm') {
                    state.isAdmin = true;
                    document.getElementById('admin-badge').classList.remove('hidden');
                    document.getElementById('admin-user-selector').classList.remove('hidden');
                    switchView('view-admin-crud');
                    Swal.fire({ icon: 'success', title: 'ยินดีต้อนรับ Admin', timer: 1000, showConfirmButton: false });
                } else if (result.value) {
                    Swal.fire({ icon: 'error', title: 'รหัสผิด' });
                }
            });
        }

        function renderCRUDLists() {
            const el = document.getElementById('list-entry-points');
            const wl = document.getElementById('list-work-points');
            const ul = document.getElementById('list-users-crud');
            if(!el || !wl || !ul) return;
            
            el.innerHTML = ''; wl.innerHTML = ''; ul.innerHTML = '';

            // Render Points
            state.entryPoints.forEach(p => el.innerHTML += createPointRow(p, 'EntryPoints'));
            state.workPoints.forEach(p => wl.innerHTML += createPointRow(p, 'WorkPoints'));
            
            // Render Users
            state.users.forEach(u => {
                ul.innerHTML += `
                    <tr>
                        <td class="px-4 py-3 font-mono text-xs">${u.id}</td>
                        <td class="px-4 py-3 font-bold">${u.nickname}</td>
                        <td class="px-4 py-3 text-center"><span class="text-[10px] px-2 py-0.5 rounded ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-gray-100 text-gray-500'}">${u.role || 'user'}</span></td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick='showUserModal(${JSON.stringify(u)})' class="p-1 text-blue-500 hover:bg-blue-50 rounded transition-colors"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="deleteUser('${u.id}')" class="p-1 text-red-500 hover:bg-red-50 rounded transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            initLucide();
        }

        function createPointRow(p, action) {
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100 text-xs">
                    <div>
                        <div class="font-bold text-gray-700">${p.name}</div>
                        <div class="text-gray-400">Lat: ${p.lat}, Lng: ${p.lng} (Range: ${p.range}m)</div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="deletePoint('${action}', '${p.name}')" class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
        }

        // --- User Modal CRUD ---
        async function showUserModal(user = null) {
            const isEdit = !!user;
            const { value: formValues } = await Swal.fire({
                title: isEdit ? 'แก้ไขข้อมูลพนักงาน' : 'เพิ่มพนักงานใหม่',
                html:
                    `<div class="text-left space-y-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">รหัสพนักงาน (ID)</label>
                        <input id="swal-uid" class="swal2-input !mt-1" placeholder="ID" value="${user ? user.id : ''}" ${isEdit ? 'disabled' : ''}>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">ชื่อเล่น</label>
                        <input id="swal-nick" class="swal2-input !mt-1" placeholder="ชื่อเล่น" value="${user ? user.nickname : ''}">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">สิทธิ์การใช้งาน</label>
                        <select id="swal-role" class="swal2-input !mt-1">
                            <option value="user" ${user && user.role === 'user' ? 'selected' : ''}>User (พนักงานทั่วไป)</option>
                            <option value="admin" ${user && user.role === 'admin' ? 'selected' : ''}>Admin (ผู้ดูแลระบบ)</option>
                        </select>
                    </div>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'บันทึกข้อมูล',
                cancelButtonText: 'ยกเลิก',
                preConfirm: () => {
                    const id = document.getElementById('swal-uid').value;
                    const nickname = document.getElementById('swal-nick').value;
                    const role = document.getElementById('swal-role').value;
                    if (!id || !nickname) return Swal.showValidationMessage('กรุณากรอก ID และชื่อเล่น');
                    return { id, nickname, role };
                }
            });

            if (formValues) {
                Swal.fire({ title: 'กำลังประมวลผล...', didOpen: () => Swal.showLoading() });
                try {
                    await fetch(`${API_URL}?action=saveUser`, { method: 'POST', body: JSON.stringify(formValues) });
                    await fetchData();
                    Swal.fire({ icon: 'success', title: isEdit ? 'อัปเดตสำเร็จ' : 'เพิ่มพนักงานสำเร็จ', timer: 1500, showConfirmButton: false });
                } catch (e) { Swal.fire({ icon: 'error', title: 'Error', text: 'บันทึกข้อมูลไม่สำเร็จ' }); }
            }
        }

        async function deleteUser(id) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: `ต้องการลบพนักงานรหัส ${id} ใช่หรือไม่? ข้อมูลการลงทะเบียนจะหายไปทั้งหมด`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'ยืนยันการลบ',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: 'กำลังลบ...', didOpen: () => Swal.showLoading() });
                await fetch(`${API_URL}?action=deleteUser`, { method: 'POST', body: JSON.stringify({ id }) });
                await fetchData();
                Swal.fire({ icon: 'success', title: 'ลบข้อมูลเรียบร้อย', timer: 1500, showConfirmButton: false });
            }
        }

        // --- Point CRUD ---
        async function showPointModal(type) {
            const { value: formValues } = await Swal.fire({
                title: 'เพิ่มจุดลงเวลา',
                html:
                    `<input id="swal-pname" class="swal2-input" placeholder="ชื่อจุด">` +
                    `<input id="swal-plat" class="swal2-input" placeholder="Latitude" value="${state.location.lat}">` +
                    `<input id="swal-plng" class="swal2-input" placeholder="Longitude" value="${state.location.lng}">` +
                    `<input id="swal-prange" class="swal2-input" placeholder="รัศมี (เมตร)" value="100">`,
                focusConfirm: false,
                preConfirm: () => ({
                    name: document.getElementById('swal-pname').value,
                    lat: document.getElementById('swal-plat').value,
                    lng: document.getElementById('swal-plng').value,
                    range: document.getElementById('swal-prange').value
                })
            });

            if (formValues) {
                if(!formValues.name) return;
                Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
                const action = type === 'EntryPoints' ? 'saveEntryPoint' : 'saveWorkPoint';
                await fetch(`${API_URL}?action=${action}`, { method: 'POST', body: JSON.stringify(formValues) });
                await fetchData();
                Swal.fire({ icon: 'success', title: 'เพิ่มสำเร็จ' });
            }
        }

        async function deletePoint(type, name) {
            const result = await Swal.fire({ title: `ยืนยันลบ ${name}?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก' });
            if(!result.isConfirmed) return;
            const action = type === 'EntryPoints' ? 'deleteEntryPoint' : 'deleteWorkPoint';
            await fetch(`${API_URL}?action=${action}`, { method: 'POST', body: JSON.stringify({ name }) });
            await fetchData();
            Swal.fire({ icon: 'success', title: 'ลบสำเร็จ' });
        }

        // --- FACE SCAN & REGISTER ---
        async function handleRegisterNext() {
            const userId = document.getElementById('reg-user-list').value;
            if(!userId) return Swal.fire('คำเตือน', 'กรุณาเลือกรายชื่อ', 'warning');
            const btn = document.getElementById('btn-next-step');
            if(state.registerStep === 1) {
                document.getElementById('face-scan-section').classList.remove('hidden');
                document.getElementById('reg-form-content').classList.add('hidden');
                btn.disabled = true; btn.innerText = "กำลังสแกนใบหน้า...";
                state.registerStep = 2;
                startRegisterScan();
            } else if (state.registerStep === 3) {
                const pin = document.getElementById('reg-pin').value;
                if(pin.length === 6 && pin === document.getElementById('reg-pin-confirm').value) saveNewUser(userId, pin);
                else Swal.fire('ผิดพลาด', 'PIN ไม่ตรงกัน', 'error');
            }
        }

        async function startRegisterScan() {
            const video = document.getElementById('reg-video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                state.currentStream = stream;
                video.srcObject = stream;
                video.onplay = () => {
                    const canvas = document.getElementById('reg-overlay');
                    faceapi.matchDimensions(canvas, { width: video.clientWidth, height: video.clientHeight });
                    const interval = setInterval(async () => {
                        const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        if (det) {
                            const nose = det.landmarks.getNose();
                            const jaw = det.landmarks.getJawOutline();
                            const noseRel = (nose[0].x - jaw[0].x) / (jaw[16].x - jaw[0].x);
                            if(noseRel > 0.45 && noseRel < 0.55) {
                                state.tempDescriptor = det.descriptor;
                                document.getElementById('scan-status').innerText = "บันทึกใบหน้าสำเร็จ!";
                                document.getElementById('scan-status').className = "text-sm font-semibold text-green-600";
                                clearInterval(interval);
                                setTimeout(finishScan, 500);
                            }
                        }
                    }, 300);
                };
            } catch (err) { Swal.fire('Error', 'ไม่สามารถใช้กล้องได้', 'error'); }
        }

        function finishScan() {
            document.getElementById('face-scan-section').classList.add('hidden');
            document.getElementById('pin-setup-section').classList.remove('hidden');
            const btn = document.getElementById('btn-next-step');
            btn.innerText = "บันทึกข้อมูลและ PIN"; btn.disabled = false;
            state.registerStep = 3;
            stopAllVideo();
        }

        async function saveNewUser(id, pin) {
            const hashedPin = CryptoJS.SHA256(pin).toString();
            const faceData = state.tempDescriptor ? JSON.stringify(Array.from(state.tempDescriptor)) : "";
            Swal.fire({ title: 'กำลังบันทึกข้อมูล...', didOpen: () => Swal.showLoading() });
            try {
                await fetch(API_URL + "?action=saveLog", { method: 'POST', body: JSON.stringify({ userId: id, pin: hashedPin, faceDescriptor: faceData, type: 'register' }) });
                Swal.fire({ icon: 'success', title: 'ลงทะเบียนสำเร็จ' });
                switchView('view-login');
                await fetchData();
            } catch (e) { Swal.fire('Error', 'บันทึกไม่ได้', 'error'); }
        }

        function updateTime() {
            const now = new Date();
            if(document.getElementById('current-time')) document.getElementById('current-time').innerText = now.toLocaleTimeString('th-TH');
            if(document.getElementById('current-date')) document.getElementById('current-date').innerText = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function retryFetchData() { fetchData(); }

        function exportCSV() {
            let csv = "\uFEFFรายชื่อ,สถานะ,เข้างาน,เข้าบริษัท,หมายเหตุ\n";
            const rows = document.querySelectorAll("#report-table-body tr");
            rows.forEach(tr => {
                const cols = tr.querySelectorAll("td");
                if(cols.length === 0) return;
                const rowData = [
                    cols[0].innerText,
                    cols[1].innerText,
                    cols[2].innerText.replace(/\n/g, ' '),
                    cols[3].innerText.replace(/\n/g, ' '),
                    cols[4].innerText
                ].map(v => `"${v}"`).join(",");
                csv += rowData + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `PFL_Report_${document.getElementById('filter-date').value}.csv`;
            link.click();
        }
    </script>
</body>
</html>
