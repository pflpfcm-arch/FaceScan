/**
 * PFL Attendance - Backend API
 * อัปเดตเพื่อรองรับการระบุตัวตนผู้บันทึก (recordedByAdmin)
 */

const SPREADSHEET_ID = "1qxS1TEInY7eeOSuEs11FELHcR17KpeeIHGaqg9ShTjA";
const SS = SpreadsheetApp.openById(SPREADSHEET_ID);

const SHEETS = {
  USERS: "Users",
  ATTENDANCE: "Attendance",
  ENTRY_POINTS: "EntryPoints",
  WORK_POINTS: "WorkPoints",
  LOGS: "Logs"
};

function doGet(e) {
  const action = e.parameter.action;
  try {
    switch (action) {
      case "getUsers": return contentResponse(getDataFromSheet(SHEETS.USERS));
      case "getAttendance": return contentResponse(getDataFromSheet(SHEETS.ATTENDANCE).reverse());
      case "getEntryPoints": return contentResponse(getDataFromSheet(SHEETS.ENTRY_POINTS));
      case "getWorkPoints": return contentResponse(getDataFromSheet(SHEETS.WORK_POINTS));
      default: return contentResponse({ error: "Invalid action" });
    }
  } catch (err) { return contentResponse({ error: err.toString() }); }
}

function doPost(e) {
  const action = e.parameter.action;
  const payload = JSON.parse(e.postData.contents);
  try {
    switch (action) {
      case "saveAttendance":
        // บันทึกลง Sheet Attendance (เพิ่มคอลัมน์สุดท้าย recordedByAdmin)
        return contentResponse(saveToSheet(SHEETS.ATTENDANCE, [
          payload.userId, payload.nickname, payload.status, 
          payload.timeWork, payload.pointWork, payload.timeCompany, 
          payload.pointCompany, payload.note, payload.lat, payload.lng, 
          payload.timestamp, payload.recordedByAdmin
        ]));

      case "saveUser": return contentResponse(upsertUser(payload));
      case "deleteUser": return contentResponse(deleteById(SHEETS.USERS, payload.id, "id"));
      case "saveEntryPoint": return contentResponse(upsertPoint(SHEETS.ENTRY_POINTS, payload));
      case "deleteEntryPoint": return contentResponse(deleteById(SHEETS.ENTRY_POINTS, payload.name, "name"));
      case "saveWorkPoint": return contentResponse(upsertPoint(SHEETS.WORK_POINTS, payload));
      case "deleteWorkPoint": return contentResponse(deleteById(SHEETS.WORK_POINTS, payload.name, "name"));
      
      case "saveLog":
        if (payload.type === 'register') updateUserRegistration(payload.userId, payload.pin, payload.faceDescriptor);
        return contentResponse(saveToSheet(SHEETS.LOGS, [payload.userId, payload.type, new Date().toISOString(), JSON.stringify(payload)]));

      default: return contentResponse({ error: "Invalid POST action" });
    }
  } catch (err) { return contentResponse({ error: err.toString() }); }
}

// --- HELPER FUNCTIONS (คงเดิมและปรับปรุง) ---
function getDataFromSheet(sheetName) {
  const sheet = SS.getSheetByName(sheetName);
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return [];
  const headers = data.shift();
  return data.map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h.toString().trim()] = row[i]);
    return obj;
  });
}

function saveToSheet(sheetName, rowData) {
  const sheet = SS.getSheetByName(sheetName);
  sheet.appendRow(rowData);
  return { status: "success" };
}

function upsertUser(payload) {
  const sheet = SS.getSheetByName(SHEETS.USERS);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const idCol = headers.indexOf("id");
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) { if (data[i][idCol] == payload.id) { rowIndex = i + 1; break; } }
  if (rowIndex > -1) {
    sheet.getRange(rowIndex, headers.indexOf("nickname") + 1).setValue(payload.nickname);
    sheet.getRange(rowIndex, headers.indexOf("role") + 1).setValue(payload.role);
  } else {
    const newRow = new Array(headers.length).fill("");
    newRow[idCol] = payload.id;
    newRow[headers.indexOf("nickname")] = payload.nickname;
    newRow[headers.indexOf("role")] = payload.role;
    sheet.appendRow(newRow);
  }
  return { status: "success" };
}

function upsertPoint(sheetName, payload) {
  const sheet = SS.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  const nameCol = data[0].indexOf("name");
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) { if (data[i][nameCol] == payload.name) { rowIndex = i + 1; break; } }
  const rowData = [payload.name, payload.lat, payload.lng, payload.range];
  if (rowIndex > -1) sheet.getRange(rowIndex, 1, 1, 4).setValues([rowData]);
  else sheet.appendRow(rowData);
  return { status: "success" };
}

function deleteById(sheetName, idValue, idColumnName) {
  const sheet = SS.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  const idCol = data[0].indexOf(idColumnName);
  for (let i = 1; i < data.length; i++) { if (data[i][idCol] == idValue) { sheet.deleteRow(i + 1); return { status: "success" }; } }
  return { status: "not_found" };
}

function updateUserRegistration(userId, hashedPin, faceDescriptor) {
  const sheet = SS.getSheetByName(SHEETS.USERS);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const idCol = headers.indexOf("id");
  for (let i = 1; i < data.length; i++) {
    if (data[i][idCol] == userId) {
      sheet.getRange(i + 1, headers.indexOf("pin") + 1).setValue(hashedPin);
      sheet.getRange(i + 1, headers.indexOf("faceDescriptor") + 1).setValue(faceDescriptor);
      return true;
    }
  }
  return false;
}

function contentResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
