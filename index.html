<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PFL Attendance – ระบบบันทึกเวลางาน ฝ่ายกำกับรถพาเหรด</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Face API & Crypto -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #ffffff; }
        .numpad-btn {
            @apply w-20 h-20 rounded-full flex items-center justify-center text-2xl font-medium bg-[#f2f2f2] text-gray-800 transition-all active:scale-90 active:bg-gray-200 select-none cursor-pointer;
        }
        .pin-dot {
            @apply w-5 h-5 rounded-full border-2 border-gray-300 transition-all duration-200;
        }
        .pin-dot.filled {
            @apply bg-[#444444] border-[#444444];
        }
        #video-container, #reg-video-container { position: relative; width: 100%; max-width: 320px; border-radius: 1rem; overflow: hidden; background: #000; }
        #login-overlay, #reg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay { transition: opacity 0.5s ease-out; }
        .tab-active { @apply border-b-2 border-blue-600 text-blue-600 font-bold; }
        
        .report-table { width: 100%; table-layout: fixed; border-collapse: collapse; }
        .report-table th, .report-table td { 
            @apply border-b border-gray-100 break-words whitespace-normal;
            padding: 8px 3px;
            font-size: 8.5px;
            vertical-align: middle;
            text-align: center;
        }
        @media (min-width: 768px) {
            .report-table th, .report-table td { font-size: 11px; padding: 12px 6px; }
        }
        .report-table th { @apply font-bold text-gray-500 uppercase bg-gray-50 tracking-tighter; }

        @media print {
            @page { size: A4 portrait; margin: 1cm; }
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            main { padding: 0; }
            thead { display: table-header-group !important; }
            #pdf-table-header-row { display: table-row !important; }
            .report-table { table-layout: auto !important; width: 100% !important; border: 0.5pt solid #000 !important; }
            .report-table th { background-color: #f3f4f6 !important; border: 0.8pt solid #000 !important; color: #000 !important; font-size: 11pt !important; padding: 10px 4px !important; }
            .report-table td { border: 0.5pt solid #ccc !important; color: #000 !important; font-size: 10pt !important; padding: 12px 6px !important; height: 42px; vertical-align: middle !important; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center space-y-4">
        <div class="loader w-12 h-12 border-4"></div>
        <p class="text-gray-600 animate-pulse font-medium text-sm text-center font-kanit">PFL Attendance กำลังเริ่มระบบ...<br><span class="text-[10px] text-gray-400 font-normal">กรุณาอนุญาตการเข้าถึงพิกัด (GPS)</span></p>
    </div>

    <!-- Header -->
    <header id="main-header" class="hidden bg-white shadow-sm p-3 sticky top-0 z-50 no-print font-kanit">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 p-1.5 rounded-lg shadow-sm"><i data-lucide="truck" class="text-white w-4 h-4"></i></div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 leading-none">PFL Attendance</h1>
                    <p class="text-[9px] text-gray-400 font-medium tracking-tight">ระบบบันทึกเวลางาน ฝ่ายกำกับรถพาเหรด</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="btn-admin-config" onclick="enterAdminSettings()" class="p-2 text-gray-400 hover:text-blue-600 transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <button onclick="logout()" class="text-sm text-red-500 font-medium flex items-center hover:bg-red-50 px-3 py-1 rounded-lg transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4 mr-1"></i> ออกจากระบบ
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-6xl p-3 space-y-5">
        
        <!-- SECTION: Login -->
        <div id="view-login" class="max-w-lg mx-auto space-y-6 text-center py-10 no-print font-kanit">
            <div class="flex justify-between items-center px-4">
                <h2 class="text-2xl font-bold text-gray-800">เข้าสู่ระบบ</h2>
                <button onclick="enterAdminSettings()" class="text-[10px] text-gray-300 hover:text-gray-500 uppercase font-bold">Admin Login</button>
            </div>
            <div class="flex justify-center space-x-8 mb-6 border-b border-gray-100 text-gray-400 text-sm">
                <button id="tab-face" onclick="switchLoginMode('face')" class="pb-2 tab-active flex items-center gap-2 transition-all font-medium"><i data-lucide="scan-face" class="w-4 h-4"></i> สแกนใบหน้า</button>
                <button id="tab-pin" onclick="switchLoginMode('pin')" class="pb-2 flex items-center gap-2 transition-all font-medium"><i data-lucide="keypad" class="w-4 h-4"></i> รหัส PIN</button>
            </div>

            <!-- Login Face -->
            <div id="login-face-section" class="space-y-4">
                <div id="video-container" class="mx-auto aspect-square ring-4 ring-blue-50 ring-offset-2">
                    <video id="login-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <canvas id="login-overlay"></canvas>
                </div>
                <p class="text-sm font-medium text-blue-600 animate-pulse" id="face-login-status">กำลังสแกนหาใบหน้า...</p>
            </div>

            <!-- Login PIN (UI From Image) -->
            <div id="login-pin-section" class="hidden flex flex-col items-center space-y-8 py-4">
                <h3 class="text-2xl font-semibold text-[#444444] mb-2">กรุณากรอกรหัสผ่าน</h3>
                <div id="pin-indicators-login" class="flex justify-center space-x-4">
                    <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
                    <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
                </div>
                <div class="grid grid-cols-3 gap-x-8 gap-y-6 max-w-xs mx-auto pt-10">
                    <button onclick="pressPin(1)" class="numpad-btn">1</button>
                    <button onclick="pressPin(2)" class="numpad-btn">2</button>
                    <button onclick="pressPin(3)" class="numpad-btn">3</button>
                    <button onclick="pressPin(4)" class="numpad-btn">4</button>
                    <button onclick="pressPin(5)" class="numpad-btn">5</button>
                    <button onclick="pressPin(6)" class="numpad-btn">6</button>
                    <button onclick="pressPin(7)" class="numpad-btn">7</button>
                    <button onclick="pressPin(8)" class="numpad-btn">8</button>
                    <button onclick="pressPin(9)" class="numpad-btn">9</button>
                    <div class="w-20 h-20"></div>
                    <button onclick="pressPin(0)" class="numpad-btn">0</button>
                    <button onclick="backspacePin()" class="w-20 h-20 flex items-center justify-center text-gray-600 active:scale-90 cursor-pointer">
                        <svg width="45" height="35" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                            <line x1="18" y1="9" x2="12" y2="15"></line>
                            <line x1="12" y1="9" x2="18" y2="15"></line>
                        </svg>
                    </button>
                </div>
                <div class="pt-4">
                    <button onclick="retryFetchData()" class="text-blue-500 flex items-center gap-1 text-sm"><i data-lucide="refresh-cw" class="w-4 h-4"></i> รีเฟรชข้อมูล</button>
                </div>
            </div>
            <p class="mt-8 text-sm text-gray-400">ยังไม่มีข้อมูลประวัติ? <button onclick="switchView('view-register')" class="text-blue-600 font-semibold underline">ลงทะเบียนใหม่</button></p>
        </div>

        <!-- SECTION: Register -->
        <div id="view-register" class="max-w-lg mx-auto hidden space-y-6 no-print font-kanit">
             <div class="flex items-center space-x-2">
                <button onclick="switchView('view-login')" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800">ลงทะเบียนพนักงาน</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                <div id="reg-form-content">
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกรายชื่อพนักงาน</label>
                    <select id="reg-user-list" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"></select>
                    <button onclick="handleRegisterNext()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all mt-4">ถัดไป</button>
                </div>
                <!-- Face Scan Step -->
                <div id="face-scan-section" class="hidden space-y-4 text-center">
                    <p class="text-sm font-semibold text-blue-600" id="scan-status">กรุณามองตรงที่กล้อง</p>
                    <div id="reg-video-container" class="mx-auto aspect-square rounded-2xl overflow-hidden bg-black ring-4 ring-blue-50">
                        <video id="reg-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                        <canvas id="reg-overlay"></canvas>
                    </div>
                </div>
                <!-- PIN Setup (UI From Image) -->
                <div id="pin-setup-section" class="hidden flex flex-col items-center space-y-8 py-4">
                    <h3 id="pin-setup-title" class="text-2xl font-semibold text-[#444444] mb-2 text-center">ตั้งรหัส PIN 6 หลัก</h3>
                    <div id="pin-indicators-reg" class="flex justify-center space-x-4">
                        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
                        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-x-8 gap-y-6 max-w-xs mx-auto pt-10">
                        <button onclick="pressPinReg(1)" class="numpad-btn">1</button>
                        <button onclick="pressPinReg(2)" class="numpad-btn">2</button>
                        <button onclick="pressPinReg(3)" class="numpad-btn">3</button>
                        <button onclick="pressPinReg(4)" class="numpad-btn">4</button>
                        <button onclick="pressPinReg(5)" class="numpad-btn">5</button>
                        <button onclick="pressPinReg(6)" class="numpad-btn">6</button>
                        <button onclick="pressPinReg(7)" class="numpad-btn">7</button>
                        <button onclick="pressPinReg(8)" class="numpad-btn">8</button>
                        <button onclick="pressPinReg(9)" class="numpad-btn">9</button>
                        <div class="w-20 h-20"></div>
                        <button onclick="pressPinReg(0)" class="numpad-btn">0</button>
                        <button onclick="backspacePinReg()" class="w-20 h-20 flex items-center justify-center text-gray-600 active:scale-90 cursor-pointer">
                            <svg width="45" height="35" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                                <line x1="18" y1="9" x2="12" y2="15"></line>
                                <line x1="12" y1="9" x2="18" y2="15"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: Main Dashboard -->
        <div id="view-main" class="hidden space-y-8 pb-10 font-kanit">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 no-print">
                <!-- Profile Card -->
                <div class="lg:col-span-1 bg-white p-5 rounded-2xl card-shadow text-center border border-gray-50 space-y-4 relative overflow-hidden">
                    <div id="admin-badge" class="hidden absolute top-2 right-2 bg-red-100 text-red-600 text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-red-200 uppercase tracking-tighter">Admin Recording</div>
                    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider">ยินดีต้อนรับคุณ</h3>
                    <div id="display-user-name" class="font-bold text-gray-800 text-xl truncate">-</div>
                    <div class="py-4 border-y border-gray-50">
                        <div class="text-4xl font-bold text-blue-600 font-mono tracking-tight" id="current-time">00:00:00</div>
                        <div class="text-gray-500 text-[11px] mt-1 font-medium" id="current-date">-</div>
                    </div>
                    <div id="gps-banner" class="flex items-center justify-center p-2.5 bg-yellow-50 text-yellow-700 rounded-xl text-[10px] border border-yellow-100 font-medium">
                        <i id="gps-icon" data-lucide="map-pin" class="w-3 h-3 mr-1"></i>
                        <span id="gps-text">กำลังเช็คตำแหน่ง GPS...</span>
                    </div>
                </div>

                <!-- Attendance Form -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl card-shadow border border-gray-100 space-y-5">
                    <div id="admin-controls-area" class="hidden pb-4 border-b border-gray-100 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-red-600 italic underline">เลือกวันที่ลงบันทึก (Admin):</label>
                                <input type="date" id="admin-record-date" class="w-full p-2.5 bg-red-50/50 border border-red-100 rounded-lg text-sm font-bold text-red-700 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-red-600">เลือกรายชื่อพนักงาน:</label>
                                <div id="admin-user-checkbox-list" class="grid grid-cols-2 gap-2 max-h-36 overflow-y-auto p-2 bg-red-50/30 rounded-lg border border-red-50 text-[10px]"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-gray-500 uppercase tracking-wide">จุดเข้าบริษัท</label>
                            <div class="flex gap-1">
                                <select id="point-company" onchange="handlePointChange('company')" class="flex-grow p-3 bg-gray-50 border border-gray-100 rounded-lg text-xs outline-none focus:ring-1 focus:ring-blue-400 font-medium">
                                    <option value="" disabled selected>เลือกจุดเข้าบริษัท</option>
                                </select>
                                <input type="time" id="time-company" disabled class="w-26 p-3 bg-white border border-blue-200 rounded-lg text-xs font-bold text-blue-600 outline-none">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-gray-500 uppercase tracking-wide">จุดเข้าหน้างาน</label>
                            <div class="flex gap-1">
                                <select id="point-work" onchange="handlePointChange('work')" class="flex-grow p-3 bg-gray-50 border border-gray-100 rounded-lg text-xs outline-none focus:ring-1 focus:ring-blue-400 font-medium">
                                    <option value="" disabled selected>เลือกจุดเข้างาน</option>
                                </select>
                                <input type="time" id="time-work" disabled class="w-26 p-3 bg-white border border-orange-200 rounded-lg text-xs font-bold text-orange-600 outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="attendance-note" rows="1" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-400" placeholder="ระบุหมายเหตุ..."></textarea>
                    
                    <div class="pt-2">
                        <button onclick="validateAndSubmit('มา')" class="w-full bg-blue-600 text-white p-3.5 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg">
                            <i data-lucide="save" class="w-5 h-5"></i> บันทึกการทำงาน
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-50">
                        <button onclick="validateAndSubmit('ลา')" class="bg-red-50 text-red-600 p-3 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition-all flex flex-col items-center justify-center">
                            <i data-lucide="x-circle" class="w-5 h-5 mb-0.5"></i>
                            <span class="text-[10px]">ลาหยุด</span>
                        </button>
                        <button onclick="validateAndSubmit('ลาครึ่งวัน')" class="bg-orange-50 text-orange-600 p-3 rounded-xl font-bold border border-orange-100 hover:bg-orange-100 transition-all flex flex-col items-center justify-center">
                            <i data-lucide="clock-3" class="w-5 h-5 mb-0.5"></i>
                            <span class="text-[10px]">ลาครึ่งวัน</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Section -->
            <div class="space-y-4">
                <div class="flex items-center justify-between flex-wrap gap-4 no-print font-kanit">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i> รายงานประจำวัน</h3>
                    <div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-gray-200 text-xs shadow-sm font-kanit">
                        <input type="date" id="filter-date" onchange="renderGlobalReport()" class="p-2 bg-transparent outline-none font-bold text-gray-700">
                        <select id="filter-status" onchange="renderGlobalReport()" class="p-2 bg-transparent outline-none font-bold border-l border-gray-100 text-gray-600">
                            <option value="ทั้งหมด">ทั้งหมด</option>
                            <option value="มา">มา</option>
                            <option value="ลา">ลา</option>
                            <option value="ลาครึ่งวัน">ลาครึ่งวัน</option>
                            <option value="ยังไม่ลงบันทึก">ยังไม่ลง</option>
                        </select>
                        <button onclick="generatePDF()" class="p-2 text-red-600 hover:bg-red-50 rounded-lg border-l border-gray-100" title="PDF"><i data-lucide="printer" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 no-print font-kanit">
                    <div class="bg-white p-4 rounded-xl border-l-4 border-green-500 shadow-sm text-center">
                        <p id="sum-present" class="text-2xl font-bold text-green-600 font-mono">0</p>
                        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">มาทำงาน</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm text-center">
                        <p id="sum-leave" class="text-2xl font-bold text-red-600 font-mono">0</p>
                        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">ลาหยุด</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-l-4 border-orange-400 shadow-sm text-center">
                        <p id="sum-half" class="text-2xl font-bold text-orange-500 font-mono">0</p>
                        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider">ลาครึ่งวัน</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-l-4 border-gray-300 shadow-sm text-center">
                        <p id="sum-missing" class="text-2xl font-bold text-gray-500 font-mono">0</p>
                        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider font-kanit">ยังไม่ลง</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative">
                    <table id="attendance-table" class="report-table font-kanit">
                        <thead>
                            <tr class="hidden" id="pdf-table-header-row">
                                <th colspan="7" class="text-center py-6 bg-white border-none">
                                    <div class="text-2xl font-bold text-black mb-2 text-center">รายงานบันทึกเวลาทำงานฝ่ายกำกับรถพาเหรด</div>
                                    <div class="text-lg font-bold text-gray-800 pdf-date-display text-center"></div>
                                </th>
                            </tr>
                            <tr class="bg-gray-50 text-gray-500 font-bold border-b border-gray-100 uppercase tracking-tighter">
                                <th class="w-[8%] text-center">#</th>
                                <th class="w-[20%] text-left">พนักงาน</th>
                                <th class="w-[12%] text-center">สถานะ</th>
                                <th class="w-[24%] text-center">เข้าหน้างาน</th>
                                <th class="w-[24%] text-center">เข้าบริษัท</th>
                                <th class="w-[12%] text-left">หมายเหตุ</th>
                                <th id="th-map" class="w-[8%] text-center no-print">Map</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-admin-crud" class="hidden space-y-6 pb-10 no-print font-kanit">
            <div class="flex items-center justify-between font-kanit"><button onclick="switchView('view-main')" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800">จัดการระบบ</h2><div></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                <div class="flex justify-between items-center"><h4 class="font-bold flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-blue-500"></i> รายชื่อพนักงาน</h4><button onclick="showUserModal()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm">+ เพิ่มพนักงาน</button></div>
                <div class="overflow-x-auto border border-gray-50 rounded-xl"><table class="w-full text-xs text-left"><thead class="bg-gray-50 font-bold text-gray-500 uppercase tracking-tight"><tr><th class="px-4 py-3 text-center">ID</th><th class="px-4 py-3">ชื่อเล่น</th><th class="px-4 py-3 text-center">สิทธิ์</th><th class="px-4 py-3 text-center">จัดการ</th></tr></thead><tbody id="list-users-crud" class="divide-y text-gray-700"></tbody></table></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4 text-green-700">
                    <h4 class="font-bold flex items-center justify-between"><span>จุดเข้าบริษัท</span> <button onclick="showPointModal('EntryPoints')" class="text-xs bg-green-600 text-white px-2 py-1 rounded shadow-sm">+ เพิ่ม</button></h4>
                    <div id="list-entry-points" class="space-y-2 text-black text-xs"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4 text-orange-700 font-kanit"><h4 class="font-bold flex items-center justify-between"><span>จุดเข้างาน</span> <button onclick="showPointModal('WorkPoints')" class="text-xs bg-orange-600 text-white px-2 py-1 rounded shadow-sm">+ เพิ่ม</button></h4>
                    <div id="list-work-points" class="space-y-2 text-black text-xs"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t p-4 text-center text-gray-400 text-[8px] uppercase tracking-widest no-print font-kanit">
        <p>COPY RIGHT 2026 @ ฝ่ายกำกับรถพาเหรด</p>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyqyQfHWTnj7yZiOyLOVs8qjU2HdtAvK1gfKhPmrCgdFTPV8WiWUZ-Q3O82Wd6c3VHX_A/exec";
        const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models"; 

        let state = {
            user: null, pin: "", pinReg: "", location: { lat: 0, lng: 0 },
            users: [], attendance: [], entryPoints: [], workPoints: [],
            view: "view-login", registerStep: 1, loginMode: "face", isAdmin: false,
            currentStream: null, faceMatcher: null, gpsError: false,
            confirmingPin: false
        };

        // --- Helper Functions FIRST to prevent ReferenceError ---
        
        function formatDateDDMMYYYY(dateString) {
            if(!dateString) return '-';
            const parts = dateString.split('-');
            if(parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            return dateString;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatTimeHHMM(t) { 
            if(!t) return ''; 
            let tStr = t.toString().trim();
            let match = tStr.match(/(\d{1,2}:\d{2})/);
            return match ? match[1] : tStr; 
        }

        // --- Core Functions ---

        window.onload = async () => {
            initLucide(); updateTime(); setInterval(updateTime, 1000);
            document.getElementById('filter-date').valueAsDate = new Date();
            try { await initFaceModels(); await fetchData(); startFaceLogin(); } catch (err) { console.error("Init Error", err); } 
            finally { 
                const overlay = document.getElementById('loading-overlay');
                if(overlay) overlay.style.display = 'none'; 
            }
            initGPS(); checkSession();
        };

        function initLucide() { if (typeof lucide !== 'undefined') lucide.createIcons(); else setTimeout(initLucide, 500); }

        async function initFaceModels() {
            if (typeof faceapi !== 'undefined' && faceapi.nets) {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
            }
        }

        async function fetchData() {
            try {
                const [uRes, aRes, epRes, wpRes] = await Promise.all([
                    fetch(`${API_URL}?action=getUsers`), fetch(`${API_URL}?action=getAttendance`),
                    fetch(`${API_URL}?action=getEntryPoints`), fetch(`${API_URL}?action=getWorkPoints`)
                ]);
                state.users = await uRes.json(); state.attendance = await aRes.json();
                state.entryPoints = await epRes.json(); state.workPoints = await wpRes.json();
                
                const labeledDescriptors = [];
                state.users.forEach(u => {
                    if (u.faceDescriptor) {
                        try {
                            const desc = new Float32Array(Object.values(JSON.parse(u.faceDescriptor)));
                            labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(u.id.toString(), [desc]));
                        } catch (e) {}
                    }
                });
                if (labeledDescriptors.length > 0) state.faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                
                populateSelectors(); renderGlobalReport(); renderCRUDLists();
            } catch (e) { console.error("Fetch Error", e); }
        }

        function populateSelectors() {
            const regList = document.getElementById('reg-user-list');
            const adminCheckList = document.getElementById('admin-user-checkbox-list');
            const epSelect = document.getElementById('point-company');
            const wpSelect = document.getElementById('point-work');

            if(regList) {
                regList.innerHTML = '<option value="" disabled selected>เลือกรายชื่อพนักงาน</option>';
                state.users.forEach(u => regList.innerHTML += `<option value="${u.id}">${u.nickname} (${u.id})</option>`);
            }
            if(adminCheckList) {
                adminCheckList.innerHTML = '';
                state.users.forEach(u => {
                    adminCheckList.innerHTML += `
                        <label class="flex items-center gap-1.5 p-1 hover:bg-red-50 rounded text-[9px] font-bold cursor-pointer transition-colors truncate">
                            <input type="checkbox" name="admin-user-target" value="${u.id}" class="w-3.5 h-3.5 rounded text-red-600 focus:ring-red-500">
                            <span class="truncate">${u.nickname} (${u.id})</span>
                        </label>`;
                });
            }
            if(epSelect) { 
                epSelect.innerHTML = '<option value="" disabled selected>เลือกจุดเข้าบริษัท</option>'; 
                state.entryPoints.forEach(p => epSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`); 
            }
            if(wpSelect) { 
                wpSelect.innerHTML = '<option value="" disabled selected>เลือกจุดเข้างาน</option>'; 
                state.workPoints.forEach(p => wpSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`); 
            }
        }

        function initGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((pos) => {
                    state.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    state.gpsError = false;
                    const gt = document.getElementById('gps-text');
                    const gb = document.getElementById('gps-banner');
                    if(gt) gt.innerText = `พิกัดปัจจุบัน: ${state.location.lat.toFixed(4)}, ${state.location.lng.toFixed(4)}`;
                    if(gb) gb.className = "flex items-center justify-center p-2 bg-green-50 text-green-700 rounded-xl text-[10px] border border-green-100 font-medium font-kanit";
                }, (err) => {
                    state.gpsError = true;
                    const gt = document.getElementById('gps-text');
                    const gb = document.getElementById('gps-banner');
                    if(gt) gt.innerText = "กรุณาเปิด GPS";
                    if(gb) gb.className = "flex items-center justify-center p-2 bg-red-50 text-red-700 rounded-xl text-[10px] border border-red-100 font-medium font-kanit";
                }, { enableHighAccuracy: true });
            }
        }

        function handlePointChange(type) {
            const selectId = type === 'company' ? 'point-company' : 'point-work';
            const timeId = type === 'company' ? 'time-company' : 'time-work';
            const pointName = document.getElementById(selectId).value;
            const points = type === 'company' ? state.entryPoints : state.workPoints;
            const pointObj = points.find(p => p.name === pointName);
            const timeInput = document.getElementById(timeId);

            if (state.isAdmin) {
                timeInput.disabled = false;
                if(!timeInput.value) {
                    const now = new Date();
                    timeInput.value = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                }
                return;
            }

            if (!state.location.lat || !state.location.lng || state.gpsError) {
                Swal.fire({ icon: 'warning', title: 'GPS ไม่ทำงาน', text: 'กรุณาเปิด GPS และรอจนกว่าพิกัดปรากฏก่อนเลือกจุด' });
                document.getElementById(selectId).value = "";
                return;
            }

            if (pointObj) {
                const dist = getDistance(state.location.lat, state.location.lng, pointObj.lat, pointObj.lng);
                if (dist > pointObj.range) {
                    Swal.fire({ 
                        icon: 'error', 
                        title: 'พิกัดห่างเกินไป', 
                        text: `คุณอยู่ห่างจากจุดเข้า${type === 'company' ? 'บริษัท' : 'งาน'} (${pointObj.name}) ระยะ ${Math.round(dist)}ม.` 
                    });
                    document.getElementById(selectId).value = ""; 
                    timeInput.disabled = true;
                    timeInput.value = "";
                } else {
                    timeInput.disabled = false;
                    const now = new Date();
                    timeInput.value = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                }
            }
        }

        function switchView(viewId) {
            stopAllVideo();
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(viewId)?.classList.remove('hidden');
            document.getElementById('main-header')?.classList.toggle('hidden', viewId === 'view-login' || viewId === 'view-register');
            if (viewId === 'view-login' && state.loginMode === 'face') startFaceLogin();
            if (viewId === 'view-main') renderGlobalReport();
            initLucide();
        }

        function switchLoginMode(mode) {
            state.loginMode = mode; stopAllVideo();
            document.getElementById('tab-face').className = mode === 'face' ? 'pb-2 tab-active flex items-center gap-1 font-medium' : 'pb-2 flex items-center gap-1 font-medium';
            document.getElementById('tab-pin').className = mode === 'pin' ? 'pb-2 tab-active flex items-center gap-1 font-medium' : 'pb-2 flex items-center gap-1 font-medium';
            document.getElementById('login-face-section').classList.toggle('hidden', mode !== 'face');
            document.getElementById('login-pin-section').classList.toggle('hidden', mode !== 'pin');
            if (mode === 'face') startFaceLogin();
            initLucide();
        }

        function stopAllVideo() { if (state.currentStream) { state.currentStream.getTracks().forEach(track => track.stop()); state.currentStream = null; } }

        async function startFaceLogin() {
            const video = document.getElementById('login-video');
            const canvas = document.getElementById('login-overlay');
            const statusEl = document.getElementById('face-login-status');
            if(!video || !canvas) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                state.currentStream = stream; video.srcObject = stream;
                video.onplay = () => {
                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    const interval = setInterval(async () => {
                        if (state.view !== 'view-login' || state.loginMode !== 'face') { clearInterval(interval); return; }
                        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height);
                        if (detection) {
                            const resized = faceapi.resizeResults(detection, displaySize);
                            new faceapi.draw.DrawBox(resized.detection.box, { label: 'กำลังสแกน...', boxColor: '#3b82f6' }).draw(canvas);
                            if (state.faceMatcher) {
                                const bestMatch = state.faceMatcher.findBestMatch(detection.descriptor);
                                if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) {
                                    const user = state.users.find(u => u.id.toString() === bestMatch.label);
                                    if (user) { 
                                        new faceapi.draw.DrawBox(resized.detection.box, { label: user.nickname, boxColor: '#10b981' }).draw(canvas);
                                        if(statusEl) statusEl.innerText = "พบใบหน้า: " + user.nickname;
                                        clearInterval(interval); setTimeout(() => loginSuccess(user), 800); 
                                    }
                                }
                            }
                        }
                    }, 300);
                };
            } catch (err) {}
        }

        // --- PIN Indicators ---
        function renderPinDotsLogin() {
            const dots = document.querySelectorAll('#pin-indicators-login .pin-dot');
            dots.forEach((dot, i) => {
                if (i < state.pin.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            });
        }
        function pressPin(num) {
            if(state.pin.length < 6) {
                state.pin += num; renderPinDotsLogin();
                if(state.pin.length === 6) setTimeout(handlePinLogin, 300);
            }
        }
        function backspacePin() { state.pin = state.pin.slice(0, -1); renderPinDotsLogin(); }
        function clearPin() { state.pin = ""; renderPinDotsLogin(); }

        function renderPinDotsReg() {
            const dots = document.querySelectorAll('#pin-indicators-reg .pin-dot');
            dots.forEach((dot, i) => {
                if (i < state.pinReg.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            });
        }
        function pressPinReg(num) {
            if(state.pinReg.length < 6) {
                state.pinReg += num; renderPinDotsReg();
                if(state.pinReg.length === 6) setTimeout(handlePinRegConfirm, 300);
            }
        }
        function backspacePinReg() { state.pinReg = state.pinReg.slice(0, -1); renderPinDotsReg(); }

        async function handlePinLogin() {
            const hashedPin = CryptoJS.SHA256(state.pin).toString();
            const user = state.users.find(u => u.pin === hashedPin);
            if(user) loginSuccess(user); 
            else { Swal.fire({ icon: 'error', title: 'รหัสผ่านผิด', text: 'กรุณาลองใหม่' }); clearPin(); }
        }

        function loginSuccess(u) { 
            state.user = u; 
            localStorage.setItem('pfl_session', JSON.stringify({ user: u, expiry: Date.now() + 28800000 })); 
            document.getElementById('display-user-name').innerText = `${u.nickname} (${u.id})`; 
            switchView('view-main'); clearPin(); 
        }

        let regFirstPin = "";
        function handlePinRegConfirm() {
            if(!state.confirmingPin) {
                regFirstPin = state.pinReg; state.pinReg = ""; state.confirmingPin = true;
                document.getElementById('pin-setup-title').innerText = "ยืนยันรหัส PIN อีกครั้ง";
                renderPinDotsReg();
            } else {
                if(state.pinReg === regFirstPin) {
                    const uid = document.getElementById('reg-user-list').value;
                    saveNewUser(uid, state.pinReg);
                } else {
                    Swal.fire({ icon: 'error', title: 'รหัสไม่ตรงกัน', text: 'กรุณาตั้งรหัสใหม่' });
                    state.pinReg = ""; regFirstPin = ""; state.confirmingPin = false;
                    document.getElementById('pin-setup-title').innerText = "ตั้งรหัส PIN 6 หลัก";
                    renderPinDotsReg();
                }
            }
        }

        async function validateAndSubmit(status) {
            let targetIds = []; 
            if (state.isAdmin) {
                const checked = document.querySelectorAll('input[name="admin-user-target"]:checked');
                checked.forEach(cb => targetIds.push(cb.value));
                if (targetIds.length === 0) return Swal.fire('แจ้งเตือน', 'กรุณาเลือกพนักงานก่อน', 'warning');
            } else { targetIds = [state.user.id]; }

            const pCompany = document.getElementById('point-company').value;
            const tCompany = document.getElementById('time-company').value;
            const pWork = document.getElementById('point-work').value;
            const tWork = document.getElementById('time-work').value;

            if (status === 'มา' && (!pCompany || !tCompany || !pWork || !tWork)) {
                return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาระบุจุดและเวลาให้ครบถ้วน', 'warning');
            }

            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const now = new Date();
            let recordTimestamp;
            if (state.isAdmin) {
                const adminDate = document.getElementById('admin-record-date').value;
                const dp = adminDate.split('-');
                recordTimestamp = `${dp[2]}/${dp[1]}/${dp[0]}, ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:00`;
            } else {
                const day = now.getDate().toString().padStart(2, '0');
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const yr = now.getFullYear();
                const hh = now.getHours().toString().padStart(2, '0');
                const mm = now.getMinutes().toString().padStart(2, '0');
                const ss = now.getSeconds().toString().padStart(2, '0');
                recordTimestamp = `${day}/${month}/${yr}, ${hh}:${mm}:${ss}`;
            }

            try {
                for (const tid of targetIds) {
                    const targetUser = state.users.find(u => u.id == tid);
                    const data = {
                        userId: tid, nickname: targetUser.nickname, status: status,
                        pointCompany: pCompany, timeCompany: tCompany, pointWork: pWork, timeWork: tWork,
                        note: document.getElementById('attendance-note').value,
                        lat: state.location.lat, lng: state.location.lng, 
                        timestamp: recordTimestamp, recordedByAdmin: state.isAdmin
                    };
                    await fetch(API_URL + "?action=saveAttendance", { method: 'POST', body: JSON.stringify(data) });
                }
                Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                document.getElementById('attendance-note').value = "";
                document.getElementById('point-company').value = "";
                document.getElementById('point-work').value = "";
                document.getElementById('time-company').disabled = true;
                document.getElementById('time-work').disabled = true;
                await fetchData(); 
            } catch (e) { Swal.fire('Error', 'บันทึกไม่สำเร็จ', 'error'); }
        }

        function renderGlobalReport() {
            const selDate = document.getElementById('filter-date').value; 
            const selStatus = document.getElementById('filter-status').value;
            const tbody = document.getElementById('report-table-body');
            const thMap = document.getElementById('th-map');
            const formattedDateDisplay = formatDateDDMMYYYY(selDate);
            document.querySelectorAll('.pdf-date-display').forEach(el => el.innerText = "ประจำวันที่: " + formattedDateDisplay);

            if(!tbody) return;
            tbody.innerHTML = "";
            let sums = { present: 0, leave: 0, half: 0, missing: 0 }; 

            if (state.isAdmin) thMap.style.display = ""; else thMap.style.display = "none";

            state.users.forEach((u, index) => {
                const att = state.attendance.find(a => {
                    if (!a.timestamp) return false;
                    const tsStr = a.timestamp.toString();
                    const dateMatch = tsStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (!dateMatch) return false;
                    const day = dateMatch[1].padStart(2, '0');
                    const month = dateMatch[2].padStart(2, '0');
                    const yr = dateMatch[3];
                    const aDate = `${yr}-${month}-${day}`; 
                    return a.userId.toString() === u.id.toString() && aDate === selDate;
                });
                
                const status = att ? att.status : "ยังไม่ลงบันทึก";
                if (status === "มา") sums.present++; else if (status === "ลา") sums.leave++; else if (status === "ลาครึ่งวัน") sums.half++; else sums.missing++;
                if (selStatus !== "ทั้งหมด" && selStatus !== status) return;

                const mapBtn = (att && state.isAdmin) ? `<button onclick="viewMap('${att.lat}', '${att.lng}')" class="text-blue-600 p-1"><i data-lucide="map" class="w-3.5 h-3.5"></i></button>` : '';
                const rowClass = ((index + 1) % 25 === 0) ? "page-break-row" : "";
                const infoClass = "font-bold text-gray-700";
                const timeClass = "font-mono font-bold";

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td>${index + 1}</td>
                        <td class="text-left font-bold text-gray-800">${u.nickname} (${u.id})</td>
                        <td><span class="px-1.5 py-0.5 rounded-full text-[7.5px] font-bold status-badge ${getStatusClass(status)}">${status}</span></td>
                        <td><span class="${infoClass}">${att?.pointWork || '-'}</span> <span class="${timeClass} text-blue-600">${att?.timeWork ? '('+formatTimeHHMM(att.timeWork)+')' : ''}</span></td>
                        <td><span class="${infoClass}">${att?.pointCompany || '-'}</span> <span class="${timeClass} text-green-600">${att?.timeCompany ? '('+formatTimeHHMM(att.timeCompany)+')' : ''}</span></td>
                        <td class="px-1 font-medium text-[7.5px] md:text-[9.5px] text-left font-kanit">${att ? (att.note || '-') : '-'}</td>
                        <td class="${state.isAdmin ? '' : 'hidden'} no-print text-center">${mapBtn}</td>
                    </tr>`;
            });

            document.getElementById('sum-present').innerText = sums.present;
            document.getElementById('sum-leave').innerText = sums.leave;
            document.getElementById('sum-half').innerText = sums.half;
            document.getElementById('sum-missing').innerText = sums.missing;
            initLucide();
        }

        function getStatusClass(s) {
            if (s === "มา") return "bg-green-100 text-green-700"; if (s === "ลา") return "bg-red-100 text-red-700";
            if (s === "ลาครึ่งวัน") return "bg-orange-100 text-orange-700"; return "bg-gray-100 text-gray-400";
        }

        function generatePDF() {
            const hr = document.getElementById('pdf-table-header-row'); if(hr) hr.classList.remove('hidden');
            window.print(); if(hr) hr.classList.add('hidden');
        }

        function viewMap(uLat, uLng) { window.open(`https://www.google.com/maps/dir/?api=1&origin=${uLat},${uLng}`, '_blank'); }

        function checkSession() { const s = localStorage.getItem('pfl_session'); if (s) { try { const sess = JSON.parse(s); if(sess.expiry > Date.now()) { state.user = sess.user; document.getElementById('display-user-name').innerText = `${state.user.nickname} (${state.user.id})`; switchView('view-main'); } } catch(e) {} } }
        function logout() { stopAllVideo(); state.isAdmin = false; localStorage.removeItem('pfl_session'); state.user = null; switchView('view-login'); }

        async function handleRegisterNext() {
            const uid = document.getElementById('reg-user-list').value; if(!uid) return Swal.fire('เตือน', 'เลือกรายชื่อก่อน', 'warning');
            if(state.registerStep === 1) {
                document.getElementById('reg-form-content').classList.add('hidden');
                document.getElementById('face-scan-section').classList.remove('hidden');
                state.registerStep = 2; startRegisterScan();
            }
        }
        async function startRegisterScan() {
            const video = document.getElementById('reg-video');
            const canvas = document.getElementById('reg-overlay');
            const statusEl = document.getElementById('scan-status');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); state.currentStream = stream; video.srcObject = stream;
                video.onplay = () => {
                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    const interval = setInterval(async () => {
                        const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height);
                        if (det) {
                            const resized = faceapi.resizeResults(det, displaySize);
                            new faceapi.draw.DrawBox(resized.detection.box, { label: 'ตรวจใบหน้าแล้ว', boxColor: '#3b82f6' }).draw(canvas);
                            const nose = det.landmarks.getNose(); const jaw = det.landmarks.getJawOutline();
                            if ((nose[0].x - jaw[0].x) / (jaw[16].x - jaw[0].x) > 0.45) {
                                state.tempDescriptor = det.descriptor; 
                                if(statusEl) statusEl.innerText = "บันทึกใบหน้าสำเร็จ!"; 
                                clearInterval(interval); finishScan();
                            }
                        }
                    }, 300);
                };
            } catch (err) { Swal.fire('Error', 'เปิดกล้องไม่ได้', 'error'); }
        }
        function finishScan() {
            document.getElementById('face-scan-section').classList.add('hidden'); document.getElementById('pin-setup-section').classList.remove('hidden');
            state.registerStep = 3; stopAllVideo();
        }
        async function saveNewUser(id, pin) {
            try {
                await fetch(API_URL + "?action=saveLog", { method: 'POST', body: JSON.stringify({ userId: id, pin: CryptoJS.SHA256(pin).toString(), faceDescriptor: JSON.stringify(Array.from(state.tempDescriptor)), type: 'register' }) });
                Swal.fire({ icon: 'success', title: 'ลงทะเบียนสำเร็จ' }); switchView('view-login'); fetchData();
            } catch (e) { Swal.fire('Error', 'บันทึกไม่สำเร็จ', 'error'); }
        }

        function enterAdminSettings() {
            if (state.user && state.user.role === 'admin') { proceedToAdminMode(); return; }
            Swal.fire({ title: 'รหัสแอดมิน', input: 'password', showCancelButton: true, confirmButtonText: 'ตกลง', fontKanit: true }).then((res) => {
                if (res.value === 'pflpfcm') proceedToAdminMode();
                else if(res.value) Swal.fire('รหัสไม่ถูกต้อง', '', 'error');
            });
        }
        function proceedToAdminMode() {
            state.isAdmin = true; 
            const b = document.getElementById('admin-badge'); if(b) b.classList.remove('hidden'); 
            const ac = document.getElementById('admin-controls-area'); if(ac) ac.classList.remove('hidden'); 
            const rd = document.getElementById('admin-record-date'); if(rd) rd.valueAsDate = new Date();
            switchView('view-admin-crud'); populateSelectors();
        }

        function renderCRUDLists() {
            const el = document.getElementById('list-entry-points'); const wl = document.getElementById('list-work-points'); const ul = document.getElementById('list-users-crud');
            if(!el || !wl || !ul) return;
            el.innerHTML = ''; wl.innerHTML = ''; ul.innerHTML = '';
            state.entryPoints.forEach(p => el.innerHTML += createPointRow(p, 'EntryPoints'));
            state.workPoints.forEach(p => wl.innerHTML += createPointRow(p, 'WorkPoints'));
            state.users.forEach(u => {
                ul.innerHTML += `<tr class="border-b font-kanit"><td class="px-4 py-3 text-center font-mono text-[9px]">${u.id}</td><td class="px-4 py-3 font-bold">${u.nickname}</td><td class="text-center text-[10px] capitalize font-medium">${u.role || 'user'}</td><td class="text-center"><div class="flex justify-center gap-1 font-kanit"><button onclick='showUserModal(${JSON.stringify(u)})' class="text-blue-600 p-1 hover:bg-blue-50 rounded transition-all"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button><button onclick="deleteUser('${u.id}')" class="text-red-600 p-1 hover:bg-red-50 rounded transition-all"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></td></tr>`;
            });
            initLucide();
        }
        function createPointRow(p, action) {
            return `<div class="flex items-center justify-between p-2.5 bg-gray-50 rounded-lg border border-gray-100 text-[10px] mb-1.5 shadow-sm font-kanit"><div><div class="font-bold text-gray-700 font-bold">${p.name}</div><div class="text-gray-400 font-mono tracking-tighter">Lat: ${p.lat}, Lng: ${p.lng} (${p.range}m)</div></div><div class="flex gap-1 font-kanit"><button onclick='showPointModal("${action}", ${JSON.stringify(p)})' class="text-blue-600 p-1 bg-white border border-blue-100 rounded hover:bg-blue-50 transition-all"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button><button onclick="deletePoint('${action}', '${p.name}')" class="text-red-600 p-1 bg-white border border-red-100 rounded hover:bg-red-50 transition-all"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></div>`;
        }
        
        async function showPointModal(type, p = null) {
            const isEdit = !!p;
            const { value: v } = await Swal.fire({
                title: isEdit ? 'แก้ไขจุด' : 'เพิ่มจุดใหม่',
                html: `<div class="space-y-3 text-left font-kanit"><div><label class="text-[10px] font-bold">ชื่อจุด</label><input id="s-name" class="swal2-input !mt-1 !mb-0 !w-full text-sm font-kanit" value="${p?p.name:''}" ${isEdit?'disabled':''}></div><div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold">Lat</label><input id="s-lat" class="swal2-input !mt-1 !mb-0 !w-full text-sm font-mono" value="${p?p.lat:state.location.lat}"></div><div><label class="text-[10px] font-bold">Lng</label><input id="s-lng" class="swal2-input !mt-1 !mb-0 !w-full text-sm font-mono" value="${p?p.lng:state.location.lng}"></div></div><button type="button" onclick="document.getElementById('s-lat').value=state.location.lat.toFixed(6);document.getElementById('s-lng').value=state.location.lng.toFixed(6)" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-[11px] shadow-sm flex items-center justify-center gap-1 font-kanit"><i data-lucide="map-pin" class="w-3.5 h-3.5"></i> ใช้พิกัดปัจจุบันของคุณ</button><div><label class="text-[10px] font-bold">ระยะอนุญาต (เมตร)</label><input id="s-range" class="swal2-input !mt-1 !mb-0 !w-full text-sm" value="${p?p.range:'100'}"></div></div>`,
                didOpen: () => { if (typeof lucide !== 'undefined') lucide.createIcons(); },
                preConfirm: () => ({ name: document.getElementById('s-name').value, lat: document.getElementById('s-lat').value, lng: document.getElementById('s-lng').value, range: document.getElementById('s-range').value })
            });
            if(v && v.name) { const action = type === 'EntryPoints' ? 'saveEntryPoint' : 'saveWorkPoint'; await fetch(`${API_URL}?action=${action}`, { method: 'POST', body: JSON.stringify(v) }); fetchData(); }
        }
        async function deletePoint(type, name) { if(!(await Swal.fire({ title: 'ลบจุดนี้?', icon: 'warning', showCancelButton: true })).isConfirmed) return; const action = type === 'EntryPoints' ? 'deleteEntryPoint' : 'deleteWorkPoint'; await fetch(`${API_URL}?action=${action}`, { method: 'POST', body: JSON.stringify({ name }) }); fetchData(); }
        async function showUserModal(u = null) {
            const isEdit = !!u;
            const { value: v } = await Swal.fire({
                title: isEdit ? 'แก้ไขพนักงาน' : 'เพิ่มพนักงาน',
                html: `<input id="s-uid" class="swal2-input text-sm" placeholder="ID (PFLxxx)" value="${u?u.id:''}" ${isEdit?'disabled':''}><input id="s-unick" class="swal2-input text-sm" placeholder="ชื่อ" value="${u?u.nickname:''}"><select id="s-urole" class="swal2-input text-sm font-kanit"><option value="user" ${u&&u.role==='user'?'selected':''}>User</option><option value="admin" ${u&&u.role==='admin'?'selected':''}>Admin</option></select>`,
                preConfirm: () => ({ id: document.getElementById('s-uid').value, nickname: document.getElementById('s-unick').value, role: document.getElementById('s-urole').value })
            });
            if(v && v.id) { await fetch(`${API_URL}?action=saveUser`, { method: 'POST', body: JSON.stringify(v) }); fetchData(); }
        }
        async function deleteUser(id) { if(!(await Swal.fire({ title: 'ลบพนักงาน?', text: `รหัส ${id}`, icon: 'warning', showCancelButton: true })).isConfirmed) return; await fetch(`${API_URL}?action=deleteUser`, { method: 'POST', body: JSON.stringify({ id }) }); fetchData(); }

        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            if(timeEl) timeEl.innerText = now.toLocaleTimeString('th-TH', { hour12: false });
            if(dateEl) dateEl.innerText = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function retryFetchData() { fetchData(); }
    </script>
</body>
</html>
