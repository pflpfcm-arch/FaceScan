<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFL Attendance - Face Login</title>
    <!-- CSS & UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- AI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background: #f8fafc; }
        .camera-box { position: relative; width: 100%; max-width: 500px; aspect-ratio: 4/3; background: #000; border-radius: 1.5rem; overflow: hidden; border: 4px solid white; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        .scan-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 3px dashed rgba(255,255,255,0.3); border-radius: 1.5rem; pointer-events: none; }
        .instruction { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 20px; border-radius: 99px; font-weight: 500; z-index: 10; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = "https://script.google.com/macros/s/AKfycbzIBHv2yvSEOnjl2rTEMYJwNPt22rh7-C3ZOjUPgby3zJoWlyaI4QcRSn5QWHiO7i2Ctw/exec";

        const App = () => {
            const [view, setView] = useState('login'); // login, register, dashboard
            const [loading, setLoading] = useState(false);
            const [isAiReady, setIsAiReady] = useState(false);
            const [status, setStatus] = useState('กำลังเตรียมระบบ...');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [users, setUsers] = useState([]);
            
            // Camera & AI Refs
            const videoRef = useRef(null);
            const faceMeshRef = useRef(null);
            const matcherRef = useRef(null);
            
            // Liveness State
            const [livenessStage, setLivenessStage] = useState(0); // 0: Start, 1: Blink, 2: Nod, 3: Success

            // Register Form
            const [regForm, setRegForm] = useState({ name: '', id: '', pin: '' });

            useEffect(() => {
                const init = async () => {
                    setLoading(true);
                    try {
                        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                        await Promise.all([
                            window.faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                            window.faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            window.faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                        ]);
                        
                        if (window.FaceMesh) {
                            faceMeshRef.current = new window.FaceMesh({
                                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
                            });
                            faceMeshRef.current.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                            faceMeshRef.current.onResults(onResults);
                        }
                        
                        setIsAiReady(true);
                        setStatus('พร้อมใช้งาน');
                        await fetchUsers();
                    } catch (e) {
                        setStatus('โหลดระบบล้มเหลว');
                        console.error(e);
                    }
                    setLoading(false);
                };
                init();
                setInterval(() => setCurrentTime(new Date()), 1000);
            }, []);

            const fetchUsers = async () => {
                const res = await fetch(`${API_URL}?action=getUsers`);
                const json = await res.json();
                if (json.data) {
                    setUsers(json.data);
                    const labeledDescriptors = json.data.map(u => {
                        if (!u.embedding) return null;
                        return new window.faceapi.LabeledFaceDescriptors(u.code.toString(), [new Float32Array(JSON.parse(u.embedding))]);
                    }).filter(x => x);
                    if (labeledDescriptors.length > 0) {
                        matcherRef.current = new window.faceapi.FaceMatcher(labeledDescriptors, 0.45);
                    }
                }
            };

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoRef.current.srcObject = stream;
                    const camera = new window.Camera(videoRef.current, {
                        onFrame: async () => {
                            if (faceMeshRef.current) await faceMeshRef.current.send({ image: videoRef.current });
                        },
                        width: 640, height: 480
                    });
                    camera.start();
                } catch (e) { alert('ไม่สามารถเข้าถึงกล้องได้'); }
            };

            const onResults = async (results) => {
                if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                    setStatus('กรุณาวางใบหน้าในกรอบ'); return;
                }
                
                const landmarks = results.multiFaceLandmarks[0];
                
                // Liveness Check logic (Simple example: Nod detection)
                const nose = landmarks[1];
                const topHead = landmarks[10];
                const chin = landmarks[152];
                const pitch = (topHead.z - chin.z) * 100;

                if (livenessStage === 0) {
                    setStatus('กรุณามองตรง');
                    if (Math.abs(pitch) < 3) setLivenessStage(1);
                } else if (livenessStage === 1) {
                    setStatus('กรุณา "พยักหน้า" (ก้มลง)');
                    if (pitch < -5) setLivenessStage(2);
                } else if (livenessStage === 2) {
                    setStatus('กรุณา "เงยหน้าขึ้น"');
                    if (pitch > 5) {
                        setLivenessStage(3);
                        processIdentification();
                    }
                }
            };

            const processIdentification = async () => {
                if (!matcherRef.current) return;
                setStatus('กำลังตรวจสอบใบหน้า...');
                const detection = await window.faceapi.detectSingleFace(videoRef.current, new window.faceapi.TinyFaceDetectorOptions()).withFaceDescriptor();
                if (detection) {
                    const bestMatch = matcherRef.current.findBestMatch(detection.descriptor);
                    if (bestMatch.label !== 'unknown') {
                        const user = users.find(u => u.code == bestMatch.label);
                        handleSuccessLogin(user, bestMatch.distance);
                    } else {
                        setStatus('ไม่พบข้อมูลใบหน้าในระบบ');
                        setLivenessStage(0);
                    }
                }
            };

            const handleSuccessLogin = async (user, distance) => {
                setStatus('บันทึกเวลาสำเร็จ!');
                setLoading(true);
                const payload = {
                    action: 'saveAttendance',
                    user_id: user.code,
                    name: user.nickname,
                    type: 'Check-in',
                    score: (1 - distance).toFixed(2),
                    location: 'Office A',
                    note: 'Face ID'
                };
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                setLoading(false);
                setView('dashboard');
            };

            const handleRegister = async () => {
                setLoading(true);
                const detection = await window.faceapi.detectSingleFace(videoRef.current, new window.faceapi.TinyFaceDetectorOptions()).withFaceDescriptor();
                if (detection) {
                    const payload = {
                        action: 'registerFace',
                        nickname: regForm.name,
                        code: regForm.id,
                        pin: regForm.pin,
                        embedding: Array.from(detection.descriptor)
                    };
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    alert('ลงทะเบียนสำเร็จ');
                    location.reload();
                } else {
                    alert('ไม่พบใบหน้า กรุณาลองใหม่');
                }
                setLoading(false);
            };

            return (
                <div className="flex flex-col min-h-screen">
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 p-2 rounded-xl text-white"><i data-lucide="shield-check"></i></div>
                            <h1 className="font-bold text-xl text-slate-800">Face Attendance</h1>
                        </div>
                        <div className="text-sm font-medium text-slate-500">{currentTime.toLocaleTimeString('th-TH')}</div>
                    </header>

                    <main className="flex-grow flex flex-col items-center p-6 space-y-6">
                        {view === 'login' && (
                            <div className="w-full max-w-md space-y-6 text-center animate-in fade-in">
                                <div className="bg-slate-900 rounded-[2.5rem] p-10 text-white shadow-2xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-8 opacity-10"><i data-lucide="clock" style={{width:100, height:100}}></i></div>
                                    <h2 className="text-5xl font-black">{currentTime.toLocaleTimeString('th-TH', {hour12:false})}</h2>
                                    <p className="text-blue-400 mt-2">{currentTime.toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'})}</p>
                                </div>
                                
                                <div className="camera-box">
                                    <video ref={videoRef} autoPlay playsInline muted />
                                    <canvas />
                                    <div className="instruction">{status}</div>
                                    <div className="scan-overlay"></div>
                                </div>

                                <div className="flex flex-col gap-3">
                                    <button onClick={startCamera} className="w-full py-5 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                                        <i data-lucide="camera"></i> เปิดกล้องสแกน
                                    </button>
                                    <button onClick={() => setView('register')} className="text-slate-500 text-sm font-medium hover:underline">ลงทะเบียนพนักงานใหม่</button>
                                </div>
                            </div>
                        )}

                        {view === 'register' && (
                            <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-sm border space-y-6 animate-in slide-in-from-bottom-4">
                                <h2 className="text-2xl font-bold text-center">ลงทะเบียนใบหน้า</h2>
                                <div className="space-y-4">
                                    <input placeholder="ชื่อเล่น" className="w-full p-4 rounded-xl bg-slate-50 border-0 ring-1 ring-slate-200 focus:ring-2 ring-blue-500" onChange={e => setRegForm({...regForm, name: e.target.value})} />
                                    <input placeholder="รหัสพนักงาน" className="w-full p-4 rounded-xl bg-slate-50 border-0 ring-1 ring-slate-200 focus:ring-2 ring-blue-500" onChange={e => setRegForm({...regForm, id: e.target.value})} />
                                    <input placeholder="PIN (ถ้ามี)" className="w-full p-4 rounded-xl bg-slate-50 border-0 ring-1 ring-slate-200 focus:ring-2 ring-blue-500" onChange={e => setRegForm({...regForm, pin: e.target.value})} />
                                </div>
                                <div className="camera-box !max-w-full"><video ref={videoRef} autoPlay playsInline muted /></div>
                                <div className="flex gap-3">
                                    <button onClick={startCamera} className="flex-1 py-4 bg-slate-100 rounded-xl font-bold">เปิดกล้อง</button>
                                    <button onClick={handleRegister} className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold">บันทึกข้อมูล</button>
                                </div>
                                <button onClick={() => setView('login')} className="w-full text-center text-slate-400 text-sm">ย้อนกลับ</button>
                            </div>
                        )}

                        {view === 'dashboard' && (
                            <div className="w-full max-w-lg bg-white p-8 rounded-3xl shadow-sm border text-center space-y-6">
                                <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto"><i data-lucide="check-circle" style={{width:40, height:40}}></i></div>
                                <h2 className="text-3xl font-bold">เข้างานเรียบร้อยแล้ว</h2>
                                <p className="text-slate-500">ระบบได้บันทึกเวลาและพิกัดของคุณเข้าสู่ฐานข้อมูลแล้ว</p>
                                <button onClick={() => location.reload()} className="px-10 py-3 bg-slate-900 text-white rounded-full font-bold">กลับหน้าแรก</button>
                            </div>
                        )}
                    </main>

                    {loading && (
                        <div className="fixed inset-0 bg-white/80 backdrop-blur-sm z-[200] flex items-center justify-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initialize Icons
        setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 1000);
    </script>
</body>
</html>
