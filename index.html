<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFL Attendance - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Face-API.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Mediapipe FaceMesh -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #F8FAFC; }
        .video-container {
            position: relative; width: 100%; max-width: 400px; margin: 0 auto; aspect-ratio: 3/4;
            background: #1e293b; border-radius: 2rem; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 4px solid white;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        .scan-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; height: 60%; border: 2px dashed rgba(255, 255, 255, 0.5); border-radius: 50%; pointer-events: none;
        }
        .num-btn { 
            width: 70px; height: 70px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 800; background: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: all 0.1s; cursor: pointer;
        }
        .num-btn:active { background: #f1f5f9; transform: scale(0.9); }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #cbd5e1; }
        .pin-dot.active { background-color: #3b82f6; border-color: #3b82f6; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        
        // --- CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzIBHv2yvSEOnjl2rTEMYJwNPt22rh7-C3ZOjUPgby3zJoWlyaI4QcRSn5QWHiO7i2Ctw/exec"; 
        const ADMIN_PASSWORD = "pflpfcm";

        // --- HELPER FUNCTIONS ---
        const formatTimeShort = (d) => d.toLocaleTimeString('th-TH', { hour12: false, hour: '2-digit', minute: '2-digit' });
        const formatDate = (d) => d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        const parseDateString = (str) => {
            if (!str) return null;
            if (typeof str === 'object' && str instanceof Date) return str;
            if (typeof str === 'string' && str.includes('/')) {
                const [d, m, y] = str.split('/').map(Number);
                return new Date(y, m - 1, d);
            }
            const d = new Date(str);
            return isNaN(d.getTime()) ? null : d;
        };

        const isSameDay = (d1, d2) => {
            if (!d1 || !d2) return false;
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        };

        const formatDisplayTime = (timeStr) => {
            if (!timeStr || timeStr === '-' || timeStr === 'undefined' || timeStr === '') return '-';
            return String(timeStr).substring(0, 5);
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('class', className);
                    i.style.width = size + 'px'; i.style.height = size + 'px';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center leading-none"></span>;
        };

        function App() {
            const [view, setView] = useState('home');
            const [loading, setLoading] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [isAdmin, setIsAdmin] = useState(false);
            const [isScanning, setIsScanning] = useState(true);
            const [modelsLoaded, setModelsLoaded] = useState(false);
            const [scanInstruction, setScanInstruction] = useState("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö...");
            
            // Data States
            const [users, setUsers] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [config, setConfig] = useState({ entryPoints: [], workPoints: [] });
            
            // Auth States
            const [currentUser, setCurrentUser] = useState(null);
            const [identifiedUser, setIdentifiedUser] = useState(null);
            const [pinInput, setPinInput] = useState("");
            const [selectedUserCode, setSelectedUserCode] = useState(""); 
            const [livenessStage, setLivenessStage] = useState(0); // 0: detect, 1: down, 2: success

            // Registration Flow States
            const [regStep, setRegStep] = useState(1);
            const [regAngles, setRegAngles] = useState({ front: null, left: null, right: null });
            const [regPin, setRegPin] = useState("");
            const [regPinConfirm, setRegPinConfirm] = useState("");
            const [regPinState, setRegPinState] = useState('entering');

            // Form States
            const [selectedEntryPoint, setSelectedEntryPoint] = useState("");
            const [selectedWorkPoint, setSelectedWorkPoint] = useState("");
            const [notes, setNotes] = useState("");

            const videoRef = useRef(null);
            const streamRef = useRef(null);
            const faceMatcher = useRef(null);
            const faceMeshRef = useRef(null);
            const requestRef = useRef();

            const [message, setMessage] = useState(null);
            const showToast = (text, type = 'info') => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 4000);
            };

            // --- CAMERA & DETECTION ---
            const stopCamera = useCallback(() => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(t => t.stop());
                    streamRef.current = null;
                }
                if (videoRef.current) videoRef.current.srcObject = null;
                if (requestRef.current) cancelAnimationFrame(requestRef.current);
            }, []);

            const processFrame = useCallback(async () => {
                if (!videoRef.current || !streamRef.current || videoRef.current.paused || videoRef.current.ended) return;
                if (faceMeshRef.current) {
                    try {
                        await faceMeshRef.current.send({ image: videoRef.current });
                    } catch (e) { console.error("Mesh processing error", e); }
                }
                requestRef.current = requestAnimationFrame(processFrame);
            }, []);

            const startCamera = useCallback(async () => {
                stopCamera();
                try {
                    const constraints = { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => {
                            videoRef.current.play().then(() => processFrame()).catch(e => console.error("Play error", e));
                        };
                    }
                } catch (err) { 
                    console.error("Camera error", err);
                    showToast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå", "error"); 
                }
            }, [stopCamera, processFrame]);

            // --- INITIAL LOAD ---
            useEffect(() => {
                const initModels = async () => {
                    setLoading(true);
                    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                    try {
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                        ]);

                        if (window.FaceMesh) {
                            faceMeshRef.current = new window.FaceMesh({
                                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
                            });
                            faceMeshRef.current.setOptions({
                                maxNumFaces: 1,
                                refineLandmarks: true,
                                minDetectionConfidence: 0.5,
                                minTrackingConfidence: 0.5
                            });
                            faceMeshRef.current.onResults(onFaceMeshResults);
                        }
                        setModelsLoaded(true);
                        await refreshData();
                    } catch (e) { showToast("‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
                    setLoading(false);
                };
                initModels();
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => { clearInterval(timer); stopCamera(); };
            }, []);

            useEffect(() => {
                const shouldBeOn = (view === 'home' && !currentUser && modelsLoaded) || (view === 'register' && regStep === 2);
                if (shouldBeOn) startCamera(); else stopCamera();
            }, [view, currentUser, modelsLoaded, regStep]);

            const refreshData = async () => {
                try {
                    const [u, a, c] = await Promise.all([
                        fetch(`${API_URL}?action=getUsers`).then(r => r.json()),
                        fetch(`${API_URL}?action=getAttendance`).then(r => r.json()),
                        fetch(`${API_URL}?action=getConfig`).then(r => r.json())
                    ]);
                    setUsers(u.data || []);
                    setAttendance(a.data || []);
                    setConfig(c.data || { entryPoints: [], workPoints: [] });
                    if (u.data) trainMatcher(u.data);
                } catch (e) { showToast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
            };

            const trainMatcher = async (userData) => {
                const labeledDescriptors = await Promise.all(userData.map(async (user) => {
                    if (!user.faces) return null;
                    try {
                        const faces = JSON.parse(user.faces);
                        const descriptors = [];
                        for (let key in faces) {
                            const img = await faceapi.fetchImage(faces[key]);
                            const d = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                            if (d) descriptors.push(d.descriptor);
                        }
                        return descriptors.length > 0 ? new faceapi.LabeledFaceDescriptors(String(user.code), descriptors) : null;
                    } catch (e) { return null; }
                }));
                const valid = labeledDescriptors.filter(x => x !== null);
                if (valid.length > 0) faceMatcher.current = new faceapi.FaceMatcher(valid, 0.45);
            };

            const onFaceMeshResults = async (results) => {
                if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                    setScanInstruction("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...");
                    return;
                }
                const landmarks = results.multiFaceLandmarks[0];
                const yaw = (landmarks[33].z - landmarks[263].z) * 100;
                const pitch = (landmarks[10].z - landmarks[152].z) * 100;

                if (view === 'register' && regStep === 2) {
                    handleRegistrationLandmarks(yaw, pitch);
                } else if (view === 'home' && !currentUser) {
                    handleLoginLandmarks(yaw, pitch);
                }
            };

            const handleRegistrationLandmarks = (yaw, pitch) => {
                if (!regAngles.front && Math.abs(yaw) < 2 && Math.abs(pitch) < 3) {
                    setScanInstruction("‡∏°‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ..."); captureAngle('front');
                } else if (regAngles.front && !regAngles.left && yaw > 10) {
                    setScanInstruction("‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); captureAngle('left');
                } else if (regAngles.left && !regAngles.right && yaw < -10) {
                    setScanInstruction("‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); captureAngle('right');
                } else if (!regAngles.front) setScanInstruction("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏ï‡∏£‡∏á...");
                else if (!regAngles.left) setScanInstruction("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢...");
                else if (!regAngles.right) setScanInstruction("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤...");
            };

            const handleLoginLandmarks = async (yaw, pitch) => {
                if (livenessStage === 0) {
                    const d = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (d && faceMatcher.current) {
                        const m = faceMatcher.current.findBestMatch(d.descriptor);
                        if (m.label !== 'unknown') {
                            setIdentifiedUser(users.find(u => String(u.code).trim() === m.label));
                            setLivenessStage(1);
                        }
                    }
                    setScanInstruction("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...");
                } else if (livenessStage === 1) {
                    setScanInstruction(`‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${identifiedUser.nickname}, "‡∏Å‡πâ‡∏°‡∏´‡∏ô‡πâ‡∏≤" ‡∏•‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`);
                    if (pitch < -5) setLivenessStage(2);
                } else if (livenessStage === 2) {
                    setScanInstruction("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÄ‡∏á‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                    if (pitch > 5) {
                        setCurrentUser(identifiedUser);
                        setLivenessStage(0); stopCamera(); showToast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                    }
                }
            };

            const captureAngle = (angle) => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                setRegAngles(prev => ({ ...prev, [angle]: dataUrl }));
            };

            const saveRegistration = async () => {
                setLoading(true);
                const payload = { action: 'register', subAction: 'updateFaces', code: selectedUserCode, faces: regAngles };
                try {
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    setRegStep(3); showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á PIN", "success");
                } catch (e) { showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error"); }
                setLoading(false);
            };

            const savePin = async (pin) => {
                setLoading(true);
                const payload = { action: 'register', subAction: 'updatePin', code: selectedUserCode, pin: pin };
                try {
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    showToast("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", "success");
                    setView('home'); setRegStep(1); setRegAngles({ front: null, left: null, right: null }); refreshData();
                } catch (e) { showToast("‡∏ï‡∏±‡πâ‡∏á PIN ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); }
                setLoading(false);
            };

            const handleClockIn = async () => {
                if (!selectedEntryPoint || !selectedWorkPoint) {
                    showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error"); return;
                }
                setLoading(true);
                const payload = {
                    action: 'clockIn', nickname: currentUser.nickname, code: currentUser.code, status: '‡∏°‡∏≤',
                    entryPoint: selectedEntryPoint, entryTime: formatTimeShort(new Date()),
                    workPoint: selectedWorkPoint, workTime: formatTimeShort(new Date()), notes: notes
                };
                try {
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                    setCurrentUser(null); setNotes(""); setIsScanning(true); refreshData();
                } catch (e) { showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error"); }
                setLoading(false);
            };

            const handlePinKey = (n) => {
                if (view === 'pin_login') {
                    const next = pinInput + n; setPinInput(next);
                    if (next.length === 6) {
                        const user = users.find(u => String(u.code).trim() === String(selectedUserCode).trim() && String(u.pin).trim() === next);
                        if (user) { setCurrentUser(user); setPinInput(""); setView('home'); setIsScanning(false); showToast("Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success"); }
                        else { showToast("‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error"); setPinInput(""); }
                    }
                } else if (view === 'register' && regStep === 3) {
                    if (regPinState === 'entering') {
                        const next = regPin + n; setRegPin(next);
                        if (next.length === 6) setRegPinState('confirming');
                    } else {
                        const next = regPinConfirm + n; setRegPinConfirm(next);
                        if (next.length === 6) {
                            if (next === regPin) savePin(next);
                            else { showToast("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà", "error"); setRegPin(""); setRegPinConfirm(""); setRegPinState('entering'); }
                        }
                    }
                }
            };

            return (
                <div className="min-h-screen flex flex-col bg-[#F8FAFC]">
                    {/* Header */}
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><Icon name="shield-check" size={24} /></div>
                            <h1 className="font-bold text-lg text-slate-800">PFL Attendance</h1>
                        </div>
                        {isAdmin ? (
                            <button onClick={() => setIsAdmin(false)} className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                        ) : (
                            <button onClick={() => { if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:") === ADMIN_PASSWORD) setIsAdmin(true); }} className="text-slate-400 p-2"><Icon name="settings" size={20} /></button>
                        )}
                    </header>

                    {/* Main Content */}
                    <main className="flex-grow p-4 pb-24 max-w-lg mx-auto w-full">
                        {message && <div className={`fixed top-20 left-1/2 -translate-x-1/2 z-[110] px-6 py-3 rounded-full text-white shadow-lg ${message.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>{message.text}</div>}
                        {loading && <div className="fixed inset-0 bg-white/60 backdrop-blur-sm z-[100] flex items-center justify-center"><div className="animate-spin text-blue-600 font-bold text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div></div>}
                        
                        {view === 'home' && !currentUser && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="bg-slate-900 rounded-[2.5rem] p-8 text-center text-white shadow-xl relative overflow-hidden">
                                    <p className="text-blue-400 font-bold uppercase tracking-widest text-sm mb-1">{formatDate(currentTime)}</p>
                                    <h2 className="text-6xl font-black tabular-nums">{formatTimeShort(currentTime)}</h2>
                                    <div className="inline-flex items-center px-4 py-1.5 rounded-full bg-blue-500/20 text-blue-300 text-xs font-bold mt-4 border border-blue-500/30">
                                        <Icon name="scan" size={14} className="mr-2" /> {scanInstruction}
                                    </div>
                                </div>

                                <div className="video-container">
                                    <video ref={videoRef} autoPlay playsInline muted />
                                    <div className="scan-guide border-blue-400/50"></div>
                                    {!modelsLoaded && <div className="absolute inset-0 bg-slate-900/90 flex items-center justify-center text-white text-sm animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö AI...</div>}
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => { setView('pin_login'); setIsScanning(false); stopCamera(); }} className="py-4 bg-white border rounded-2xl font-bold text-slate-600 shadow-sm flex items-center justify-center gap-2 active:bg-slate-50">
                                        <Icon name="key-round" size={18} /> ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™ PIN
                                    </button>
                                    <button onClick={refreshData} className="py-4 bg-white border rounded-2xl font-bold text-slate-600 shadow-sm flex items-center justify-center gap-2 text-blue-600 active:bg-slate-50">
                                        <Icon name="refresh-cw" size={18} /> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                    </button>
                                </div>

                                {/* Recent History */}
                                <div className="space-y-3 pt-2">
                                    <h3 className="font-bold text-slate-800 ml-2 flex items-center gap-2 text-sm uppercase tracking-wider text-slate-400"><Icon name="history" size={16}/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                                    <div className="space-y-2">
                                        {attendance.slice(0, 5).map((rec, i) => (
                                            <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center animate-in slide-in-from-bottom">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 font-bold uppercase">{rec.name ? rec.name.charAt(0) : '?'}</div>
                                                    <div>
                                                        <p className="text-sm font-bold text-slate-800">{rec.name || 'Unknown'}</p>
                                                        <p className="text-[10px] text-slate-400 font-medium">{rec.entrypoint || '-'} &rarr; {rec.workpoint || '-'}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-xs font-black text-blue-600">{rec.entrytime || '--:--'}</p>
                                                    <p className="text-[9px] text-slate-300 font-bold uppercase">{rec.status}</p>
                                                </div>
                                            </div>
                                        ))}
                                        {attendance.length === 0 && <div className="text-center py-8 text-slate-300 italic text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'home' && currentUser && (
                            <div className="bg-white rounded-[2.5rem] p-8 shadow-sm border space-y-6 animate-in zoom-in border-blue-100">
                                <div className="flex items-center gap-4 bg-blue-50/50 p-5 rounded-3xl">
                                    <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-blue-200">{currentUser.nickname.charAt(0)}</div>
                                    <div>
                                        <h3 className="font-black text-2xl text-slate-800">‡∏Ñ‡∏∏‡∏ì{currentUser.nickname}</h3>
                                        <p className="text-blue-600 text-sm font-bold tracking-widest">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™: {currentUser.code}</p>
                                    </div>
                                </div>
                                <div className="space-y-5">
                                    <div className="space-y-2">
                                        <label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                                        <select value={selectedEntryPoint} onChange={(e) => setSelectedEntryPoint(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 focus:ring-2 ring-blue-500 font-bold text-slate-700 outline-none">
                                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à (Canteen/Guard)...</option>
                                            {config.entryPoints.map((p, i) => <option key={i} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">üíº ‡∏à‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
                                        <select value={selectedWorkPoint} onChange={(e) => setSelectedWorkPoint(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 focus:ring-2 ring-blue-500 font-bold text-slate-700 outline-none">
                                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏á‡∏≤‡∏ô (CM / PF / FTI)...</option>
                                            {config.workPoints.map((p, i) => <option key={i} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                                        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 h-28 resize-none font-medium text-slate-600 focus:ring-2 ring-blue-500 outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏£‡∏ñ‡∏ï‡∏¥‡∏î, ‡∏•‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô..."></textarea>
                                    </div>
                                </div>
                                <div className="pt-2">
                                    <button onClick={handleClockIn} className="w-full py-5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all flex items-center justify-center gap-3"><Icon name="save" /> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
                                    <button onClick={() => { setCurrentUser(null); setIsScanning(true); }} className="w-full mt-3 text-slate-300 text-sm font-bold py-2 hover:text-slate-400 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                                </div>
                            </div>
                        )}

                        {view === 'register' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="bg-white rounded-[2rem] p-8 shadow-sm border text-center">
                                    <h2 className="text-2xl font-black text-slate-800">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                                    <div className="flex justify-center gap-2 mt-4 px-10">
                                        {[1,2,3].map(s => <div key={s} className={`h-1.5 flex-1 rounded-full transition-all duration-500 ${regStep >= s ? 'bg-blue-600 shadow-sm' : 'bg-slate-100'}`}></div>)}
                                    </div>
                                    
                                    {regStep === 1 && (
                                        <div className="mt-10 space-y-6">
                                            <div className="text-left space-y-2">
                                                <label className="text-xs font-black text-slate-400 uppercase ml-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                                <select value={selectedUserCode} onChange={(e) => setSelectedUserCode(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 font-bold outline-none focus:ring-2 ring-blue-500">
                                                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ --</option>
                                                    {users.map((u, i) => <option key={i} value={u.code}>{u.nickname} ({u.code})</option>)}
                                                </select>
                                            </div>
                                            <div className="bg-blue-50 p-5 rounded-2xl flex items-start gap-4 border border-blue-100">
                                                <Icon name="info" className="text-blue-500 shrink-0 mt-0.5" size={20} />
                                                <p className="text-xs text-blue-700 leading-relaxed text-left font-medium">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ 3 ‡∏°‡∏∏‡∏° (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á-‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤) ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN 6 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
                                            </div>
                                            <button disabled={!selectedUserCode} onClick={() => setRegStep(2)} className="w-full py-5 bg-blue-600 text-white rounded-2xl font-black shadow-lg disabled:opacity-30 active:scale-95 transition-all">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                                        </div>
                                    )}

                                    {regStep === 2 && (
                                        <div className="mt-8 space-y-6">
                                            <p className="text-sm font-bold text-blue-600 bg-blue-50 py-2.5 rounded-xl animate-pulse tracking-wide">{scanInstruction}</p>
                                            <div className="video-container border-2 border-slate-100">
                                                <video ref={videoRef} autoPlay playsInline muted />
                                                <div className="scan-guide border-white/30"></div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                {['front', 'left', 'right'].map(a => (
                                                    <div key={a} className={`p-3 rounded-2xl border-2 transition-all flex flex-col items-center gap-1 ${regAngles[a] ? 'border-green-500 bg-green-50 text-green-600 shadow-inner' : 'border-slate-100 text-slate-300'}`}>
                                                        <Icon name={regAngles[a] ? "check-circle" : "camera"} size={24} />
                                                        <span className="block text-[9px] font-black uppercase">{a === 'front' ? '‡∏ï‡∏£‡∏á' : a === 'left' ? '‡∏ã‡πâ‡∏≤‡∏¢' : '‡∏Ç‡∏ß‡∏≤'}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            {regAngles.front && regAngles.left && regAngles.right && (
                                                <button onClick={saveRegistration} className="w-full py-5 bg-green-600 text-white rounded-2xl font-black shadow-lg shadow-green-100 animate-in zoom-in">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN</button>
                                            )}
                                        </div>
                                    )}

                                    {regStep === 3 && (
                                        <div className="mt-8 space-y-8 animate-in slide-in-from-bottom">
                                            <div className="space-y-1">
                                                <h3 className="text-xl font-black text-slate-800">{regPinState === 'entering' ? '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN 6 ‡∏´‡∏•‡∏±‡∏Å' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ PIN ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö'}</h3>
                                                <p className="text-xs text-slate-400 font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 6 ‡∏ï‡∏±‡∏ß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á</p>
                                            </div>
                                            <div className="flex justify-center gap-4">
                                                {[0,1,2,3,4,5].map(i => <div key={i} className={`pin-dot ${ (regPinState === 'entering' ? regPin.length : regPinConfirm.length) > i ? 'active' : '' }`}></div>)}
                                            </div>
                                            <div className="max-w-[300px] mx-auto">
                                                <PinPad onKey={handlePinKey} onClear={() => regPinState === 'entering' ? setRegPin("") : setRegPinConfirm("")} onBack={() => regPinState === 'entering' ? setRegPin(p => p.slice(0,-1)) : setRegPinConfirm(p => p.slice(0,-1))} />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'pin_login' && (
                            <div className="max-w-md mx-auto space-y-8 animate-in fade-in">
                                <div className="text-center space-y-6">
                                    <div className="w-20 h-20 bg-blue-100 rounded-3xl flex items-center justify-center text-blue-600 mx-auto shadow-sm"><Icon name="key-round" size={36} /></div>
                                    <h2 className="text-2xl font-black text-slate-800">Login ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ PIN</h2>
                                    <div className="text-left space-y-2 px-6">
                                        <label className="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</label>
                                        <select value={selectedUserCode} onChange={(e) => setSelectedUserCode(e.target.value)} className="w-full p-4 bg-white rounded-2xl border-2 border-slate-100 font-bold shadow-sm outline-none focus:border-blue-500 text-slate-700">
                                            <option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ --</option>
                                            {users.map((u, i) => <option key={i} value={u.code}>{u.nickname} ({u.code})</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="flex justify-center gap-5 py-2">
                                    {[0,1,2,3,4,5].map(i => <div key={i} className={`pin-dot ${pinInput.length > i ? 'active' : ''}`}></div>)}
                                </div>
                                <div className="max-w-[300px] mx-auto">
                                    <PinPad onKey={handlePinKey} onClear={() => setPinInput("")} onBack={() => setPinInput(p => p.slice(0,-1))} />
                                </div>
                                <button onClick={() => { setView('home'); setIsScanning(true); }} className="w-full text-slate-400 font-bold text-sm hover:text-slate-600 py-4 transition-colors uppercase tracking-widest">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t px-10 py-4 pb-10 flex justify-between items-center z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
                        <button onClick={() => { setView('home'); stopCamera(); setCurrentUser(null); setIsScanning(true); setLivenessStage(0); }} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'home' ? 'text-blue-600 scale-110' : 'text-slate-300 hover:text-slate-400'}`}>
                            <Icon name="clock" size={26} strokeWidth={view === 'home' ? 2.5 : 2} />
                            <span className="text-[10px] font-black uppercase tracking-tighter">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
                        </button>
                        <button onClick={() => { setView('register'); setRegStep(1); stopCamera(); }} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'register' ? 'text-blue-600 scale-110' : 'text-slate-300 hover:text-slate-400'}`}>
                            <Icon name="user-plus" size={26} strokeWidth={view === 'register' ? 2.5 : 2} />
                            <span className="text-[10px] font-black uppercase tracking-tighter">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
                        </button>
                        <button onClick={() => { refreshData(); showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }} className="flex flex-col items-center gap-1.5 text-slate-300 hover:text-blue-500 active:rotate-180 transition-all duration-500">
                            <Icon name="refresh-cw" size={26} />
                            <span className="text-[10px] font-black uppercase tracking-tighter">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
                        </button>
                    </nav>

                    <footer className="fixed bottom-2 w-full text-center pointer-events-none opacity-25"><p className="text-[8px] font-black uppercase tracking-widest">¬© 2026 PFL ATTENDANCE | SECURITY SECURE</p></footer>
                </div>
            );
        }

        const PinPad = ({ onKey, onClear, onBack }) => (
            <div className="grid grid-cols-3 gap-y-4 gap-x-6">
                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                    <div key={num} onClick={() => onKey(num.toString())} className="num-btn">{num}</div>
                ))}
                <div onClick={onClear} className="num-btn text-red-500 hover:bg-red-50"><Icon name="x" size={24} strokeWidth={3}/></div>
                <div onClick={() => onKey("0")} className="num-btn">0</div>
                <div onClick={onBack} className="num-btn text-slate-400 hover:bg-slate-50"><Icon name="delete" size={24}/></div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
