<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFL Attendance – ลงเวลาทำงาน</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Face API & Crypto -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .numpad-btn {
            @apply w-16 h-16 rounded-full flex items-center justify-center text-xl font-semibold bg-white shadow-sm border border-gray-100 hover:bg-blue-50 transition-all active:scale-95;
        }
        .step-active { @apply bg-blue-600 text-white; }
        .step-inactive { @apply bg-gray-200 text-gray-500; }
        #video-container { position: relative; width: 100%; max-width: 400px; border-radius: 1rem; overflow: hidden; background: #000; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay { transition: opacity 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center space-y-4">
        <div class="loader w-12 h-12 border-4"></div>
        <p class="text-gray-600 animate-pulse font-medium">กำลังเริ่มต้นระบบ...</p>
        <p id="loading-subtext" class="text-gray-400 text-xs text-center px-4">กรุณารอสักครู่ ระบบกำลังโหลดโมเดลสแกนใบหน้าและข้อมูลพนักงาน</p>
        <!-- Fail-safe Button (Show after 3s) -->
        <button id="skip-loading" onclick="hideOverlay()" class="hidden mt-4 text-blue-500 text-sm font-semibold underline">ข้ามหน้าโหลด (ใช้งานโหมดจำลอง)</button>
    </div>

    <!-- Main Navigation -->
    <header id="main-header" class="hidden bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="truck" class="text-white w-5 h-5"></i></div>
                <h1 class="text-lg font-bold text-gray-800">PFL Attendance</h1>
            </div>
            <button onclick="toggleAdminMode()" class="text-sm bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 flex items-center transition-colors">
                <i data-lucide="shield-check" class="w-4 h-4 mr-1"></i> แอดมิน
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-lg p-4">
        
        <!-- SECTION: Login -->
        <div id="view-login" class="space-y-6 text-center py-10">
            <h2 class="text-2xl font-bold text-gray-800">เข้าสู่ระบบ</h2>
            <p class="text-gray-500">ใส่รหัส PIN 6 หลัก</p>
            
            <div class="flex justify-center space-x-3 my-6">
                <template id="pin-dot-template"><div class="w-4 h-4 rounded-full border-2 border-blue-200 transition-all duration-300"></div></template>
                <div id="pin-display" class="flex space-x-3"></div>
            </div>

            <div class="grid grid-cols-3 gap-4 max-w-xs mx-auto">
                <button onclick="pressPin(1)" class="numpad-btn">1</button>
                <button onclick="pressPin(2)" class="numpad-btn">2</button>
                <button onclick="pressPin(3)" class="numpad-btn">3</button>
                <button onclick="pressPin(4)" class="numpad-btn">4</button>
                <button onclick="pressPin(5)" class="numpad-btn">5</button>
                <button onclick="pressPin(6)" class="numpad-btn">6</button>
                <button onclick="pressPin(7)" class="numpad-btn">7</button>
                <button onclick="pressPin(8)" class="numpad-btn">8</button>
                <button onclick="pressPin(9)" class="numpad-btn">9</button>
                <button onclick="retryFetchData()" class="numpad-btn text-blue-500"><i data-lucide="refresh-cw" class="w-6 h-6"></i></button>
                <button onclick="pressPin(0)" class="numpad-btn">0</button>
                <button onclick="clearPin()" class="numpad-btn text-red-500"><i data-lucide="delete"></i></button>
            </div>
            <p class="mt-8 text-sm text-gray-400">ยังไม่ได้ลงทะเบียน? <button onclick="switchView('view-register')" class="text-blue-600 font-semibold underline">ลงทะเบียนใหม่</button></p>
            
            <!-- Demo Mode Indicator -->
            <div id="demo-mode-banner" class="hidden mt-6 p-3 bg-orange-50 border border-orange-200 rounded-xl text-orange-700 text-xs">
                <div class="font-bold flex items-center justify-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> โหมดสาธิต (Offline/Demo)</div>
                <p class="mt-1">ระบบไม่สามารถเชื่อมต่อ API ได้ จึงใช้ข้อมูลจำลองแทน</p>
                <p class="mt-1 font-mono bg-white p-1 rounded border">PIN ทดสอบ: 123456</p>
            </div>
        </div>

        <!-- SECTION: Register -->
        <div id="view-register" class="hidden space-y-6">
            <div class="flex items-center space-x-2">
                <button onclick="switchView('view-login')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-xl font-bold">ลงทะเบียนพนักงาน</h2>
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-md space-y-4 border border-gray-100">
                <div id="reg-form-loading" class="hidden flex items-center justify-center p-4">
                    <div class="loader mr-2"></div> <span class="text-sm text-gray-500">กำลังโหลดรายชื่อ...</span>
                </div>
                
                <div id="reg-form-content">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ค้นหาและเลือกชื่อของคุณ</label>
                    <select id="reg-user-list" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                        <option value="">-- กรุณาเลือกรายชื่อ --</option>
                    </select>
                </div>

                <!-- Face Scan UI -->
                <div id="face-scan-section" class="hidden space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <p class="text-sm font-semibold text-blue-600" id="scan-status">ขั้นตอนที่ 1: หน้าตรง</p>
                        <div class="flex space-x-1">
                            <div id="step-1" class="w-3 h-3 rounded-full bg-gray-200 transition-colors"></div>
                            <div id="step-2" class="w-3 h-3 rounded-full bg-gray-200 transition-colors"></div>
                            <div id="step-3" class="w-3 h-3 rounded-full bg-gray-200 transition-colors"></div>
                        </div>
                    </div>
                    <div id="video-container" class="mx-auto aspect-square">
                        <video id="video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                        <canvas id="overlay"></canvas>
                    </div>
                </div>

                <!-- PIN Setup UI -->
                <div id="pin-setup-section" class="hidden space-y-4">
                    <p class="text-center font-medium text-gray-700">ตั้งรหัส PIN 6 หลัก</p>
                    <input type="password" id="reg-pin" maxlength="6" inputmode="numeric" class="w-full text-center text-3xl tracking-[0.5em] p-4 bg-gray-50 border border-gray-200 rounded-xl focus:border-blue-500 outline-none" placeholder="******">
                    <input type="password" id="reg-pin-confirm" maxlength="6" inputmode="numeric" class="w-full text-center text-3xl tracking-[0.5em] p-4 bg-gray-50 border border-gray-200 rounded-xl focus:border-blue-500 outline-none" placeholder="******">
                    <p class="text-xs text-center text-gray-400">* ใช้สำหรับเข้าสู่ระบบในครั้งถัดไป</p>
                </div>

                <button id="btn-next-step" onclick="handleRegisterNext()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all disabled:opacity-50">เริ่มการลงทะเบียน</button>
            </div>
        </div>

        <!-- SECTION: Main Dashboard -->
        <div id="view-main" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm text-center border border-gray-50">
                <h3 class="text-gray-400 text-sm">ยินดีต้อนรับ</h3>
                <div id="display-user-name" class="font-bold text-gray-800 text-xl">-</div>
                <div class="text-4xl font-bold text-blue-600 my-2" id="current-time">00:00:00</div>
                <div class="text-gray-500 text-sm" id="current-date">-</div>
            </div>

            <div id="gps-banner" class="flex items-center p-3 bg-yellow-50 text-yellow-700 rounded-xl text-xs border border-yellow-100 transition-colors">
                <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                <span id="gps-text">กำลังตรวจสอบพิกัด GPS...</span>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm space-y-4 border border-gray-50">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-gray-500">จุดเข้าบริษัท</label>
                        <select id="point-company" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-400">
                            <option>จุดตรวจ1 (แคนทีน)</option>
                            <option>จุดตรวจ3 (PF)</option>
                            <option>จุดตรวจ4 (FTI)</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-gray-500">เวลาเข้าบริษัท</label>
                        <input type="time" id="time-company" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-gray-500">จุดเข้างาน</label>
                        <select id="point-work" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-400">
                            <option>CM</option>
                            <option>PF</option>
                            <option>FTI</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-gray-500">เวลาเข้างาน</label>
                        <input type="time" id="time-work" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-500">หมายเหตุ</label>
                    <textarea id="attendance-note" rows="2" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-lg text-sm" placeholder="ระบุเหตุผลกรณีมาสาย หรืออื่นๆ..."></textarea>
                </div>

                <button id="btn-submit-attendance" onclick="submitAttendance()" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700 transition-all flex items-center justify-center disabled:opacity-50">
                    <span id="submit-text" class="flex items-center"><i data-lucide="check-circle" class="mr-2 w-5 h-5"></i> บันทึกเวลาทำงาน</span>
                </button>
            </div>
        </div>

        <!-- SECTION: Admin -->
        <div id="view-admin" class="hidden space-y-6">
            <div class="flex items-center justify-between">
                <button onclick="switchView('view-main')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800">ข้อมูลการลงเวลา</h2>
                <button onclick="logout()" class="text-red-500 text-sm font-medium hover:underline">ออก</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-50 text-gray-500 font-medium">
                            <tr>
                                <th class="px-4 py-3">พนักงาน</th>
                                <th class="px-4 py-3 text-center">เข้าบริษัท</th>
                                <th class="px-4 py-3 text-center">เข้างาน</th>
                                <th class="px-4 py-3 text-center">จุดงาน</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body" class="divide-y divide-gray-50">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t p-6 text-center text-gray-400 text-[10px] uppercase tracking-widest">
        <p>COPY RIGHT 2026 @ ฝ่ายกำกับรถพาเหรด</p>
    </footer>

    <!-- Notification Modal -->
    <div id="modal-alert" class="fixed inset-0 z-[110] bg-black/60 hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center space-y-4 shadow-2xl animate-in zoom-in duration-300">
            <div id="modal-icon" class="mx-auto flex items-center justify-center w-16 h-16 rounded-full"></div>
            <h4 id="modal-title" class="text-xl font-bold text-gray-800"></h4>
            <div class="text-left bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs text-gray-600 max-h-40 overflow-y-auto">
                <p id="modal-message" class="whitespace-pre-wrap"></p>
            </div>
            <button onclick="closeModal()" class="w-full bg-gray-900 text-white p-4 rounded-2xl font-semibold active:scale-95 transition-transform">เข้าใจแล้ว</button>
        </div>
    </div>

    <script>
        /** * ระบบ PFL Attendance
         * แก้ไขปัญหาค้างหน้าโหลด และอัปเดต API URL ล่าสุด
         */
        const API_URL = "https://script.google.com/macros/s/AKfycbyqyQfHWTnj7yZiOyLOVs8qjU2HdtAvK1gfKhPmrCgdFTPV8WiWUZ-Q3O82Wd6c3VHX_A/exec".trim();
        const ADMIN_PASS = "pflpfcm";
        const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models"; 
        
        const MOCK_USERS = [
            { id: "DEMO001", nickname: "พนักงานตัวอย่าง", pin: CryptoJS.SHA256("123456").toString() },
            { id: "DEMO002", nickname: "สมชาย ใจดี", pin: CryptoJS.SHA256("111111").toString() }
        ];

        let state = {
            user: null, pin: "", location: { lat: 0, lng: 0, accuracy: 0 },
            view: "view-login", registerStep: 1, 
            scanProgress: { front: false, left: false, right: false },
            users: [],
            isDemoMode: false,
            points: {
                company: [{name: "จุดตรวจ1 (แคนทีน)", lat: 13.7563, lng: 100.5018, range: 2000}], 
            }
        };

        // --- Optimized Fetch with Fallback ---
        async function fetchWithRetry(url, options = {}, retries = 1, backoff = 800) {
            const separator = url.includes('?') ? '&' : '?';
            const urlWithTime = `${url}${separator}_t=${Date.now()}`;

            const secureOptions = {
                ...options,
                method: options.method || 'GET',
                redirect: 'follow',
                credentials: 'omit',
            };
            
            if (state.isDemoMode) return []; 

            try {
                const response = await fetch(urlWithTime, secureOptions);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw error;
            }
        }

        function hideOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }
        }

        window.onload = async () => {
            initLucide();
            updateTime();
            setInterval(updateTime, 1000);
            
            // Fail-safe: ถ้าผ่านไป 3 วินาทียังไม่โหลดเสร็จ ให้แสดงปุ่มข้าม
            setTimeout(() => {
                const skipBtn = document.getElementById('skip-loading');
                if (skipBtn) skipBtn.classList.remove('hidden');
            }, 3000);

            // บังคับปิด Overlay หลังจาก 8 วินาที
            setTimeout(hideOverlay, 8000);

            try {
                // โหลดโมเดล
                initFaceModels();
                // โหลดข้อมูลจาก API URL ล่าสุด
                await fetchData();
            } catch (err) {
                console.error("Initialization error:", err);
            } finally {
                hideOverlay();
            }

            initGPS();
            renderPinDots();
            checkSession();
        };

        function initLucide() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            else setTimeout(initLucide, 500);
        }

        async function initFaceModels() {
            try {
                if (typeof faceapi !== 'undefined' && faceapi.nets) {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                }
            } catch (err) { 
                console.warn("FaceAPI Models failed to load"); 
            }
        }

        async function retryFetchData() {
            state.isDemoMode = false;
            document.getElementById('demo-mode-banner').classList.add('hidden');
            showAlert("กำลังเชื่อมต่อใหม่", "ระบบกำลังพยายามเชื่อมต่อฐานข้อมูลพนักงาน...", "info");
            fetchData();
        }

        async function fetchData() {
            const select = document.getElementById('reg-user-list');
            const loading = document.getElementById('reg-form-loading');
            
            if (loading) loading.classList.remove('hidden');
            
            try {
                if (!API_URL || API_URL.includes("YOUR_APPS_SCRIPT") || API_URL === "") {
                    throw new Error("API URL is missing");
                }

                const data = await fetchWithRetry(`${API_URL}?action=getUsers`);
                if (data.error) throw new Error(data.error);
                
                state.users = data;
                populateUserSelect(state.users);
            } catch (e) { 
                console.warn("Switching to Demo Mode:", e.message);
                state.isDemoMode = true;
                state.users = MOCK_USERS;
                populateUserSelect(state.users);
                if (document.getElementById('demo-mode-banner')) document.getElementById('demo-mode-banner').classList.remove('hidden');
            } finally {
                if (loading) loading.classList.add('hidden');
            }
        }

        function populateUserSelect(users) {
            const select = document.getElementById('reg-user-list');
            if (!select) return;
            select.innerHTML = '<option value="">-- กรุณาเลือกรายชื่อ --</option>';
            if (Array.isArray(users)) {
                users.forEach(u => {
                    if (u.nickname && u.id) {
                        const opt = document.createElement('option');
                        opt.value = u.id;
                        opt.textContent = `${u.nickname} (${u.id})`;
                        select.appendChild(opt);
                    }
                });
            }
        }

        function initGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        state.location = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
                        const gpsText = document.getElementById('gps-text');
                        const gpsBanner = document.getElementById('gps-banner');
                        if (gpsText) gpsText.innerText = `พิกัดปัจจุบัน: ${state.location.lat.toFixed(5)}, ${state.location.lng.toFixed(5)}`;
                        if (gpsBanner) {
                            gpsBanner.classList.replace('bg-yellow-50', 'bg-green-50');
                            gpsBanner.classList.replace('text-yellow-700', 'text-green-700');
                        }
                    },
                    (err) => { 
                        const gpsText = document.getElementById('gps-text');
                        if (gpsText) gpsText.innerText = "ไม่สามารถระบุพิกัดได้ (กรุณาเปิดตำแหน่ง)";
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function switchView(viewId) {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            const target = document.getElementById(viewId);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('animate-in', 'fade-in', 'duration-500');
            }
            const header = document.getElementById('main-header');
            if (header) header.classList.toggle('hidden', viewId === 'view-login' || viewId === 'view-register');
            initLucide();
        }

        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            if(timeEl) timeEl.innerText = now.toLocaleTimeString('th-TH');
            if(dateEl) dateEl.innerText = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const tC = document.getElementById('time-company');
            const tW = document.getElementById('time-work');
            const hhmm = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            if(tC && !tC.value) tC.value = hhmm;
            if(tW && !tW.value) tW.value = hhmm;
        }

        function renderPinDots() {
            const container = document.getElementById('pin-display');
            if (!container) return;
            container.innerHTML = "";
            const template = document.getElementById('pin-dot-template');
            for(let i=0; i<6; i++) {
                const dot = template.content.cloneNode(true).querySelector('div');
                if(i < state.pin.length) {
                    dot.classList.remove('border-blue-200');
                    dot.classList.add('bg-blue-600', 'border-blue-600', 'scale-125');
                }
                container.appendChild(dot);
            }
        }

        function pressPin(num) {
            if(state.pin.length < 6) {
                state.pin += num;
                renderPinDots();
                if(state.pin.length === 6) setTimeout(handleLogin, 300);
            }
        }

        function clearPin() { state.pin = ""; renderPinDots(); }

        async function handleLogin() {
            if (typeof CryptoJS === 'undefined') {
                showAlert("ขัดข้อง", "ไม่พบไลบรารีเข้ารหัส", "error");
                return;
            }
            const hashedPin = CryptoJS.SHA256(state.pin).toString();
            
            if (state.users.length === 0) {
                await fetchData(); 
            }

            const user = state.users.find(u => u.pin === hashedPin);
            
            if(user) {
                state.user = user;
                localStorage.setItem('pfl_session', JSON.stringify({ user, expiry: Date.now() + 28800000 }));
                const displayEl = document.getElementById('display-user-name');
                if (displayEl) displayEl.innerText = user.nickname;
                switchView('view-main');
            } else {
                showAlert("เข้าสู่ระบบล้มเหลว", "รหัส PIN ไม่ถูกต้อง", "error");
                clearPin();
            }
        }

        function checkSession() {
            const sessionStr = localStorage.getItem('pfl_session');
            if (sessionStr) {
                try {
                    const session = JSON.parse(sessionStr);
                    if(session.expiry > Date.now()) {
                        state.user = session.user;
                        const displayEl = document.getElementById('display-user-name');
                        if (displayEl) displayEl.innerText = state.user.nickname;
                        switchView('view-main');
                    }
                } catch(e) { localStorage.removeItem('pfl_session'); }
            }
        }

        function logout() { localStorage.removeItem('pfl_session'); state.user = null; switchView('view-login'); clearPin(); }

        async function handleRegisterNext() {
            const select = document.getElementById('reg-user-list');
            if (!select) return;
            const userId = select.value;
            if(!userId) return showAlert("เตือน", "กรุณาเลือกรายชื่อของคุณก่อน", "warning");
            const btn = document.getElementById('btn-next-step');

            if(state.registerStep === 1) {
                document.getElementById('face-scan-section').classList.remove('hidden');
                document.getElementById('reg-form-content').classList.add('hidden');
                if (btn) { btn.innerText = "กำลังประมวลผล..."; btn.disabled = true; }
                state.registerStep = 2;
                startVideo();
            } else if (state.registerStep === 3) {
                const pin = document.getElementById('reg-pin').value;
                const confirm = document.getElementById('reg-pin-confirm').value;
                if(pin.length === 6 && pin === confirm) saveNewUser(userId, pin);
                else showAlert("PIN ไม่ตรงกัน", "กรุณาใส่รหัสทั้งสองช่องให้เหมือนกัน", "error");
            }
        }

        async function startVideo() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                video.onplay = () => {
                    const canvas = document.getElementById('overlay');
                    if (canvas && typeof faceapi !== 'undefined') {
                        faceapi.matchDimensions(canvas, { width: video.clientWidth, height: video.clientHeight });
                        const interval = setInterval(async () => {
                            const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                            if (det) {
                                const nose = det.landmarks.getNose();
                                const jaw = det.landmarks.getJawOutline();
                                const noseRel = (nose[0].x - jaw[0].x) / (jaw[16].x - jaw[0].x);
                                
                                if(!state.scanProgress.front && noseRel > 0.45 && noseRel < 0.55) {
                                    state.scanProgress.front = true;
                                    const s1 = document.getElementById('step-1');
                                    const stat = document.getElementById('scan-status');
                                    if (s1) s1.classList.add('bg-green-500');
                                    if (stat) stat.innerText = "ขั้นตอนที่ 2: หันซ้าย";
                                } else if(state.scanProgress.front && !state.scanProgress.left && noseRel < 0.35) {
                                    state.scanProgress.left = true;
                                    const s2 = document.getElementById('step-2');
                                    const stat = document.getElementById('scan-status');
                                    if (s2) s2.classList.add('bg-green-500');
                                    if (stat) stat.innerText = "ขั้นตอนที่ 3: หันขวา";
                                } else if(state.scanProgress.left && !state.scanProgress.right && noseRel > 0.65) {
                                    state.scanProgress.right = true;
                                    const s3 = document.getElementById('step-3');
                                    if (s3) s3.classList.add('bg-green-500');
                                    clearInterval(interval);
                                    finishScan();
                                }
                            }
                        }, 300);
                    }
                };
            } catch (err) { showAlert("ไม่สามารถเข้าถึงกล้อง", "กรุณาอนุญาตการใช้กล้องในเบราว์เซอร์", "error"); }
        }

        function finishScan() {
            document.getElementById('face-scan-section').classList.add('hidden');
            document.getElementById('pin-setup-section').classList.remove('hidden');
            const btn = document.getElementById('btn-next-step');
            if (btn) { btn.innerText = "ยืนยันการตั้งค่ารหัส PIN"; btn.disabled = false; }
            state.registerStep = 3;
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        }

        async function saveNewUser(id, pin) {
            if (state.isDemoMode) {
                showAlert("Demo Mode", "ในโหมดสาธิต ระบบจะไม่บันทึกข้อมูลจริง", "info");
                switchView('view-login');
                return;
            }
            if (typeof CryptoJS === 'undefined') return;
            const hashedPin = CryptoJS.SHA256(pin).toString();
            try {
                await fetchWithRetry(`${API_URL}?action=saveLog`, { 
                    method: 'POST', 
                    body: JSON.stringify({ userId: id, pin: hashedPin, type: 'register' }) 
                });
                showAlert("ลงทะเบียนสำเร็จ", "คุณสามารถใช้รหัส PIN เข้าสู่ระบบได้ทันที", "success");
                switchView('view-login');
                await fetchData();
            } catch (e) { showAlert("Error", "ไม่สามารถส่งข้อมูลได้", "error"); }
        }

        async function submitAttendance() {
            if (!state.user) return;
            if (state.isDemoMode) {
                showAlert("บันทึกสำเร็จ (Demo)", "นี่คือโหมดสาธิต ข้อมูลจะไม่ถูกบันทึกจริง", "success");
                document.getElementById('attendance-note').value = "";
                return;
            }
            const btn = document.getElementById('btn-submit-attendance');
            if (btn) btn.disabled = true;
            const data = {
                userId: state.user.id, nickname: state.user.nickname,
                pointCompany: document.getElementById('point-company').value,
                timeCompany: document.getElementById('time-company').value,
                pointWork: document.getElementById('point-work').value,
                timeWork: document.getElementById('time-work').value,
                note: document.getElementById('attendance-note').value,
                lat: state.location.lat, lng: state.location.lng, timestamp: new Date().toISOString()
            };
            try {
                await fetchWithRetry(`${API_URL}?action=saveAttendance`, { method: 'POST', body: JSON.stringify(data) });
                showAlert("บันทึกสำเร็จ", "ส่งข้อมูลเข้าระบบเรียบร้อย", "success");
                document.getElementById('attendance-note').value = "";
            } catch (e) { showAlert("ล้มเหลว", "ไม่สามารถบันทึกได้ กรุณาลองใหม่", "error"); }
            finally { if (btn) btn.disabled = false; }
        }

        function toggleAdminMode() {
            const pass = prompt("กรุณาใส่รหัสผ่านแอดมิน:");
            if(pass === ADMIN_PASS) { switchView('view-admin'); loadAttendanceData(); }
            else if (pass !== null) showAlert("ไม่อนุญาต", "รหัสผ่านแอดมินไม่ถูกต้อง", "error");
        }

        async function loadAttendanceData() {
            const tbody = document.getElementById('attendance-table-body');
            if (!tbody) return;
            tbody.innerHTML = "<tr><td colspan='4' class='text-center p-4 text-gray-400'>กำลังโหลด...</td></tr>";
            
            if (state.isDemoMode) {
                tbody.innerHTML = "<tr><td colspan='4' class='text-center p-4 text-orange-400'>โหมดสาธิตไม่มีข้อมูลจริง</td></tr>";
                return;
            }

            try {
                const items = await fetchWithRetry(`${API_URL}?action=getAttendance`);
                if (Array.isArray(items)) {
                    tbody.innerHTML = items.map(i => `
                        <tr class='border-b hover:bg-gray-50 transition-colors'>
                            <td class='px-4 py-3 font-medium text-gray-800'>${i.nickname}</td>
                            <td class='px-4 py-3 text-center text-gray-600'>${i.timeCompany || '-'}</td>
                            <td class='px-4 py-3 text-center text-gray-600'>${i.timeWork || '-'}</td>
                            <td class='px-4 py-3 text-center'><span class='bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100'>${i.pointWork}</span></td>
                        </tr>
                    `).join('');
                }
            } catch (e) { tbody.innerHTML = "<tr><td colspan='4' class='text-center p-4 text-red-500 font-medium'>โหลดข้อมูลล้มเหลว</td></tr>"; }
        }

        function showAlert(title, msg, type) {
            const modal = document.getElementById('modal-alert');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = msg;
            const icon = document.getElementById('modal-icon');
            if (type === 'success') {
                icon.className = "mx-auto flex items-center justify-center w-16 h-16 rounded-full bg-green-100 text-green-600";
                icon.innerHTML = '<i data-lucide="check" class="w-8 h-8"></i>';
            } else if (type === 'error') {
                icon.className = "mx-auto flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-600";
                icon.innerHTML = '<i data-lucide="x" class="w-8 h-8"></i>';
            } else {
                icon.className = "mx-auto flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600";
                icon.innerHTML = '<i data-lucide="info" class="w-8 h-8"></i>';
            }
            modal.classList.remove('hidden');
            initLucide();
        }

        function closeModal() { document.getElementById('modal-alert').classList.add('hidden'); }
    </script>
</body>
</html>
